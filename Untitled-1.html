<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLADIATOR DOMINUS - Antik Roma Gladyatör İmparatorluğu</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        /* CSS kodunda herhangi bir değişiklik yapılmamıştır, aynı kalmıştır. */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Trajan+Pro:wght@400;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --gold: #ffd700; --dark-gold: #b8860b; --roman-red: #8B0000; --dark-red: #5d0000; --marble: #f5f5dc; --dark-marble: #e6e6cd; --bronze: #cd7f32; --shadow: rgba(0, 0, 0, 0.3); --hp-green: #4CAF50; --hp-red: #F44336; }
        body { font-family: 'Cinzel', serif; background: linear-gradient(135deg, #2c1810 0%, #1a0f08 50%, #0f0704 100%); color: var(--marble); overflow-x: hidden; min-height: 100vh; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes glowPulse { 0%, 100% { text-shadow: 0 0 10px var(--gold), 0 0 20px var(--gold), 0 0 30px var(--gold); } 50% { text-shadow: 0 0 20px var(--gold), 0 0 30px var(--gold), 0 0 40px var(--gold); } }
        @keyframes coinFlip { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
        @keyframes swordClash { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
        .game-container { position: relative; min-height: 100vh; background-image: radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.05) 0%, transparent 50%); }
        .game-header { background: linear-gradient(45deg, var(--roman-red), var(--dark-red)); border-bottom: 3px solid var(--gold); padding: 15px 0; box-shadow: 0 5px 15px var(--shadow); position: sticky; top: 0; z-index: 500; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .game-title { font-family: 'Trajan Pro', serif; font-size: 2.5em; color: var(--gold); text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7); animation: glowPulse 3s ease-in-out infinite; }
        .resources { display: flex; gap: 30px; }
        .resource-item { display: flex; align-items: center; gap: 8px; background: rgba(0, 0, 0, 0.3); padding: 8px 15px; border-radius: 20px; border: 2px solid var(--gold); }
        .resource-icon { color: var(--gold); font-size: 1.2em; }
        .resource-value { font-weight: 600; font-size: 1.1em; }
        .main-game { display: grid; grid-template-columns: 250px 1fr 300px; gap: 20px; max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .sidebar { background: linear-gradient(180deg, rgba(139, 0, 0, 0.2), rgba(0, 0, 0, 0.4)); border: 2px solid var(--bronze); border-radius: 10px; padding: 20px; backdrop-filter: blur(10px); align-self: start; }
        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 10px; }
        .nav-button { width: 100%; background: linear-gradient(45deg, var(--bronze), var(--dark-gold)); color: var(--marble); border: none; padding: 15px; border-radius: 8px; font-family: 'Cinzel', serif; font-size: 1em; font-weight: 500; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        .nav-button:hover { background: linear-gradient(45deg, var(--gold), var(--bronze)); border-color: var(--gold); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3); }
        .nav-button.active { background: linear-gradient(45deg, var(--gold), var(--dark-gold)); border-color: var(--gold); box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3); }
        .content-area { background: linear-gradient(135deg, rgba(245, 245, 220, 0.1), rgba(0, 0, 0, 0.3)); border: 2px solid var(--gold); border-radius: 15px; padding: 30px; backdrop-filter: blur(5px); position: relative; overflow: hidden; min-height: 70vh; }
        .content-area::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: repeating-linear-gradient( 45deg, transparent, transparent 2px, rgba(255, 215, 0, 0.03) 2px, rgba(255, 215, 0, 0.03) 4px ); pointer-events: none; }
        .section { display: none; animation: fadeInUp 0.6s ease-out; }
        .section.active { display: block; }
        .section-title { font-size: 2.2em; color: var(--gold); margin-bottom: 25px; text-align: center; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); border-bottom: 3px solid var(--gold); padding-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .gladiator-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .gladiator-card { background: linear-gradient(135deg, rgba(139, 0, 0, 0.3), rgba(0, 0, 0, 0.6)); border: 2px solid var(--bronze); border-radius: 12px; padding: 20px; transition: all 0.3s ease; cursor: pointer; position: relative; overflow: hidden; }
        .gladiator-card:hover { border-color: var(--gold); transform: translateY(-5px); box-shadow: 0 10px 25px rgba(255, 215, 0, 0.2); }
        .gladiator-card::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent); transition: left 0.6s ease; }
        .gladiator-card:hover::after { left: 100%; }
        .gladiator-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gladiator-name { font-size: 1.3em; font-weight: 600; color: var(--gold); }
        .gladiator-type { background: var(--roman-red); color: white; padding: 4px 8px; border-radius: 15px; font-size: 0.8em; text-transform: uppercase; }
        .gladiator-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-item { display: flex; justify-content: space-between; align-items: center; background: rgba(0, 0, 0, 0.3); padding: 8px 12px; border-radius: 6px; border-left: 3px solid var(--gold); }
        .stat-label { font-size: 0.9em; color: var(--marble); }
        .stat-value { font-weight: 600; color: var(--gold); }
        .arena-container { background: radial-gradient(circle, rgba(139, 0, 0, 0.3), rgba(0, 0, 0, 0.7)); border: 3px solid var(--gold); border-radius: 20px; padding: 30px; text-align: center; position: relative; overflow: hidden; }
        .arena-container::before { content: ''; position: absolute; top: 50%; left: 50%; width: 80%; height: 80%; background: repeating-conic-gradient( from 0deg, transparent 0deg, rgba(255, 215, 0, 0.1) 10deg, transparent 20deg ); transform: translate(-50%, -50%) rotate(0deg); animation: rotate 20s linear infinite; pointer-events: none; }
        @keyframes rotate { 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .arena-title { font-size: 2.5em; color: var(--gold); margin-bottom: 20px; text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8); position: relative; z-index: 1; }
        .battle-setup { display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: start; margin: 30px 0; position: relative; z-index: 1; }
        .gladiator-selector { background: rgba(0, 0, 0, 0.5); border: 2px solid var(--bronze); border-radius: 10px; padding: 20px; min-height: 150px; }
        .vs-symbol { font-size: 3em; color: var(--gold); text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); animation: swordClash 2s ease-in-out infinite; align-self: center; }
        .btn { background: linear-gradient(45deg, var(--roman-red), var(--dark-red)); color: var(--marble); border: 2px solid var(--gold); padding: 12px 25px; border-radius: 25px; font-family: 'Cinzel', serif; font-size: 1em; font-weight: 500; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; margin: 5px; }
        .btn:hover:not(:disabled) { background: linear-gradient(45deg, var(--gold), var(--dark-gold)); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4); }
        .btn:disabled { background: #555; color: #999; border-color: #777; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        .btn-primary { background: linear-gradient(45deg, var(--gold), var(--dark-gold)); color: var(--dark-red); font-weight: 600; }
        .info-panel { background: linear-gradient(180deg, rgba(205, 127, 50, 0.2), rgba(0, 0, 0, 0.4)); border: 2px solid var(--bronze); border-radius: 10px; padding: 20px; backdrop-filter: blur(10px); align-self: start; }
        .info-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 215, 0, 0.3); }
        .info-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .info-title { font-size: 1.3em; color: var(--gold); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .news-item { background: rgba(0, 0, 0, 0.3); padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid var(--gold); font-size: 0.9em; line-height: 1.4; }
        .news-item:last-child { margin-bottom: 0; }
        .training-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .training-option { background: linear-gradient(135deg, rgba(139, 0, 0, 0.2), rgba(0, 0, 0, 0.5)); border: 2px solid var(--bronze); border-radius: 10px; padding: 20px; text-align: center; transition: all 0.3s ease; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; }
        .training-option:hover { border-color: var(--gold); background: linear-gradient(135deg, rgba(139, 0, 0, 0.3), rgba(0, 0, 0, 0.6)); }
        .training-option.disabled { opacity: 0.5; cursor: not-allowed; }
        .training-icon { font-size: 2.5em; color: var(--gold); margin-bottom: 15px; }
        .training-name { font-size: 1.2em; color: var(--marble); margin-bottom: 10px; font-weight: 600; }
        .training-cost { color: var(--gold); font-weight: 500; }
        .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .market-item { background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(0, 0, 0, 0.5)); border: 2px solid var(--bronze); border-radius: 8px; padding: 15px; text-align: center; transition: all 0.3s ease; }
        .market-item:hover { border-color: var(--gold); transform: scale(1.02); }
        .item-name { font-weight: 600; color: var(--gold); margin-bottom: 8px; }
        .item-price { color: var(--marble); display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 10px; }
        .battle-log { margin-top: 20px; background: rgba(0,0,0,0.5); border-radius: 8px; padding: 15px; height: 150px; overflow-y: auto; text-align: left; font-family: 'Times New Roman', serif; line-height: 1.6; border: 1px solid var(--bronze); }
        .progress-bar { width: 100%; height: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 5px; overflow: hidden; margin: 8px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--gold), var(--dark-gold)); border-radius: 5px; transition: width 0.3s ease; }
        .health-bar { position: relative; width: 100%; height: 15px; background: var(--dark-red); border: 1px solid var(--roman-red); border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .health-fill { height: 100%; background: var(--hp-green); transition: width 0.3s ease, background-color 0.3s ease; border-radius: 5px; position: relative; }
        .health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.75em; /* Daha küçük font boyutu */
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            z-index: 2;
            white-space: nowrap;
        }
        
        /* Battle log özel stilleri */
        .battle-log p { margin-bottom: 5px; }
        .battle-log p:last-child { margin-bottom: 0; }
        .battle-log .event { color: var(--gold); font-weight: bold; }
        .battle-log .player-attack { color: var(--hp-green); }
        .battle-log .opponent-attack { color: var(--hp-red); }
        .battle-log .crit { color: yellow; font-weight: bold; }
        .battle-log .miss { color: gray; font-style: italic; }
        .battle-log .victory { color: #00ff00; font-weight: bold; }
        .battle-log .defeat { color: var(--hp-red); font-weight: bold; }
        .battle-log .info { color: #2196F3; font-style: italic; }

        .battle-speed-controls { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .battle-speed-controls .btn { padding: 8px 15px; font-size: 0.9em; }
        .battle-speed-controls .btn.active { background: linear-gradient(45deg, var(--dark-gold), var(--gold)); color: var(--roman-red); border-color: var(--roman-red); }


        @media (max-width: 1200px) { .main-game { grid-template-columns: 200px 1fr 250px; } }
        @media (max-width: 992px) { .main-game { grid-template-columns: 1fr; gap: 15px; padding: 0 15px; } .sidebar, .info-panel { order: 2; } .content-area { order: 1; } .header-content { flex-direction: column; gap: 10px; } }
        @media (max-width: 768px) { .game-title { font-size: 1.8em; } .resources { gap: 15px; flex-wrap: wrap; justify-content: center; } .resource-item { padding: 6px 10px; } .gladiator-grid { grid-template-columns: 1fr; } .battle-setup { grid-template-columns: 1fr; } }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); border-radius: 6px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--gold), var(--bronze)); border-radius: 6px; border: 2px solid rgba(0, 0, 0, 0.3); }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, var(--bronze), var(--dark-gold)); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 2000; transition: opacity 0.5s ease; pointer-events: none; }
        .loading-content { text-align: center; color: var(--gold); }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid rgba(255, 215, 0, 0.3); border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification-container { position: fixed; top: 100px; right: 20px; z-index: 1500; display: flex; flex-direction: column; gap: 10px; }
        .notification { background: linear-gradient(45deg, var(--roman-red), var(--dark-red)); color: var(--marble); padding: 15px 20px; border-radius: 8px; border-left: 5px solid var(--gold); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-out 3.5s forwards; max-width: 350px; display: flex; align-items: center; gap: 10px;}
        .notification i { font-size: 1.2em; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }
        .notification.success { background: linear-gradient(45deg, #2d5a27, #1e3a1c); border-color: #4caf50; }
        .notification.error { background: linear-gradient(45deg, var(--roman-red), var(--dark-red)); border-color: #f44336; }
        .notification.info { background: linear-gradient(45deg, #2a3e5e, #1a273b); border-color: #2196F3; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-overlay.show { display: flex; }
        .modal-content { background: linear-gradient(135deg, var(--dark-red), #2c1810); border: 3px solid var(--gold); border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; animation: modalSlideIn 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes modalSlideIn { from { transform: scale(0.7) translateY(-50px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--gold); }
        .modal-title { font-size: 1.8em; color: var(--gold); font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--gold); font-size: 1.8em; cursor: pointer; transition: color 0.3s ease, transform 0.3s ease; }
        .modal-close:hover { color: var(--marble); transform: rotate(90deg); }
        .modal-footer { margin-top: 25px; text-align: right; }
        .attack-animation { animation: battleFlash 0.5s ease-in-out; }
        @keyframes battleFlash { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); filter: brightness(1.5); } } /* Hafifletildi */

        /* Modal içeriği özel styles */
        .modal-content .gladiator-details { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;}
        .modal-content .gladiator-details p { margin: 0; }
        .modal-content .inventory-list, .modal-content .equipped-list { list-style: none; padding: 0; margin-top: 15px; }
        .modal-content .inventory-list li, .modal-content .equipped-list li {
            background: rgba(0, 0, 0, 0.3); padding: 10px 15px; border-radius: 8px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-content .inventory-list li button, .modal-content .equipped-list li button {
            margin-left: 10px; padding: 6px 12px; font-size: 0.8em; border-radius: 5px;
        }
        .modal-content .inventory-list li button.btn-equip { background: #4CAF50; border-color: #2e7d32; }
        .modal-content .inventory-list li button.btn-use { background: #2196F3; border-color: #1976d2; }
        .modal-content .inventory-list li button.btn-sell { background: #FF9800; border-color: #f57c00; }
        .modal-content .equipped-list li button.btn-unequip { background: var(--roman-red); border-color: var(--dark-red); }
        .modal-content .equipped-list li button.btn-upgrade { background: #673AB7; border-color: #512DA8; } /* Purple for upgrade */


        .modal-content h4 { color: var(--gold); margin-top: 20px; margin-bottom: 10px; border-bottom: 1px dashed var(--bronze); padding-bottom: 5px; }
        .item-stats-summary { font-size: 0.8em; color: var(--marble); margin-left: 10px; }
        .item-rarity { font-size: 0.7em; margin-left: 5px; text-transform: uppercase; font-weight: bold;}
        /* Rarity colors */
        .rarity-common { color: #aaaaaa; }
        .rarity-uncommon { color: #5cb85c; } /* Green */
        .rarity-rare { color: #5bc0de; } /* Blue */
        .rarity-epic { color: #9c27b0; } /* Purple */
        .rarity-legendary { color: var(--gold); } /* Gold */

        /* New Gladiator Recruitment Options */
        .recruit-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .recruit-option-card {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(0, 0, 0, 0.5));
            border: 2px solid var(--bronze);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .recruit-option-card:hover:not(.disabled) {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(0, 0, 0, 0.6));
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.2);
        }
        .recruit-option-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .recruit-option-card .option-icon { font-size: 3em; color: var(--gold); margin-bottom: 15px; }
        .recruit-option-card .option-name { font-size: 1.3em; color: var(--marble); margin-bottom: 10px; font-weight: 600; }
        .recruit-option-card .option-desc { font-size: 0.9em; color: var(--marble); line-height: 1.4; margin-bottom: 15px; }
        .recruit-option-card .option-cost { color: var(--gold); font-weight: 500; }
        .recruit-option-card .option-stats { font-size: 0.8em; color: var(--marble); }

        /* Map & Arena Styles */
        .map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .location-card {
            background: linear-gradient(135deg, rgba(42, 62, 94, 0.2), rgba(0, 0, 0, 0.5)); /* Darker blueish */
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .location-card:hover {
            border-color: var(--gold);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(33, 150, 243, 0.2);
        }
        .location-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(80%);
            border-color: gray;
        }
        .location-card .location-title { font-size: 1.5em; color: var(--gold); margin-bottom: 10px; }
        .location-card .location-desc { font-size: 0.9em; color: var(--marble); margin-bottom: 15px; }
        .arena-list { list-style: none; padding: 0; }
        .arena-list li {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            margin-bottom: 5px;
            border-left: 3px solid #2196F3;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .arena-list li strong { color: var(--gold); }
        .arena-list li span { font-size: 0.8em; color: var(--marble); }
        .arena-list li.locked { opacity: 0.7; }
        .arena-list li.locked i { color: var(--roman-red); }

        /* Palace Section */
        .palace-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), rgba(0, 0, 0, 0.2));
            border: 2px solid var(--gold);
            border-radius: 10px;
        }
        .palace-stat-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--gold);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .palace-stat-item i {
            font-size: 2em;
            color: var(--gold);
        }
        .palace-stat-content strong {
            font-size: 1.2em;
            color: var(--gold);
            display: block;
        }
        .palace-stat-content span {
            font-size: 0.9em;
            color: var(--marble);
        }

        /* Quest List */
        .quest-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        .quest-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--bronze);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .quest-item.completed {
            opacity: 0.7;
            filter: grayscale(50%);
            border-color: var(--hp-green);
        }
        .quest-item.active {
            border-color: var(--gold);
        }
        .quest-item .quest-title {
            font-size: 1.1em;
            color: var(--gold);
            font-weight: 600;
        }
        .quest-item .quest-description {
            font-size: 0.9em;
            color: var(--marble);
        }
        .quest-item .quest-rewards {
            font-size: 0.85em;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quest-item .quest-buttons {
            text-align: right;
        }

        /* Market Categories */
        .market-categories {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .market-categories .btn {
            padding: 10px 20px;
            font-size: 0.9em;
        }

        /* Bank Section */
        .bank-info {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.05), rgba(0, 0, 0, 0.2));
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }
        .bank-info p {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .bank-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .bank-controls input {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--bronze);
            background: rgba(0, 0, 0, 0.3);
            color: var(--marble);
            width: 120px;
            text-align: center;
        }
        .bank-controls .btn {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        /* Legends Section */
        .legends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .legend-card {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.2), rgba(0, 0, 0, 0.5));
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .legend-card:hover:not(.disabled) {
            border-color: var(--marble);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
        }
        .legend-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(80%);
            border-color: gray;
        }
        .legend-card .legend-icon { font-size: 3.5em; color: var(--gold); margin-bottom: 15px; }
        .legend-card .legend-name { font-size: 1.5em; font-weight: 600; color: var(--gold); margin-bottom: 10px; }
        .legend-card .legend-desc { font-size: 0.9em; color: var(--marble); margin-bottom: 15px; }
        .legend-card .legend-cost { color: var(--gold); font-weight: 500; margin-bottom: 10px; }
        .legend-card .legend-stats { font-size: 0.8em; color: var(--marble); }
        .legend-card .legend-traits { font-size: 0.8em; color: var(--marble); margin-top: 5px; }

    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content"><div class="loading-spinner"></div><p>İmparatorluk Yükleniyor...</p></div>
    </div>
    <div id="notification-container"></div>

    <div class="game-container">
        <header class="game-header">
             <div class="header-content">
                <h1 class="game-title">GLADIATOR DOMINUS</h1>
                <div class="resources">
                    <div class="resource-item"><i class="fas fa-coins resource-icon"></i><span class="resource-value" id="gold-val"></span></div>
                    <div class="resource-item"><i class="fas fa-gem resource-icon"></i><span class="resource-value" id="gems-val"></span></div>
                    <div class="resource-item"><i class="fas fa-star resource-icon"></i><span class="resource-value" id="reputation-val"></span></div>
                </div>
            </div>
        </header>

        <main class="main-game">
            <aside class="sidebar">
                <nav>
                    <ul class="nav-menu" id="nav-menu">
                        <li class="nav-item"><button class="nav-button active" data-section="palace"><i class="fas fa-city"></i> Saray</button></li>
                        <li class="nav-item"><button class="nav-button" data-section="gladiators"><i class="fas fa-users"></i> Gladyatörler</button></li>
                        <li class="nav-item"><button class="nav-button" data-section="map"><i class="fas fa-map-marked-alt"></i> Harita</button></li>
                        <li class="nav-item"><button class="nav-button" data-section="arena"><i class="fas fa-gavel"></i> Arena</button></li>
                        <li class="nav-item"><button class="nav-button" data-section="training"><i class="fas fa-dumbbell"></i> Eğitim</button></li>
                        <li class="nav-item"><button class="nav-button" data-section="barracks"><i class="fas fa-bed"></i> Kışla</button></li>
                        <li class="nav-item"><button class="nav-button" data-section="market"><i class="fas fa-store"></i> Pazar</button></li>
                        <li class="nav-item"><button class="nav-button" data-section="bank"><i class="fas fa-bank"></i> Banka</button></li>
                        <li class="nav-item"><button class="nav-button" data-section="quests"><i class="fas fa-scroll"></i> Görevler</button></li>
                        <li class="nav-item"><button class="nav-button" data-section="legends"><i class="fas fa-medal"></i> Efsaneler</button></li>
                    </ul>
                </nav>
            </aside>

            <section class="content-area">
                <div class="section active" id="palace">
                    <h2 class="section-title"><i class="fas fa-city"></i> İmparatorluk Sarayı</h2>
                    <div class="palace-stats">
                        <div class="palace-stat-item">
                            <i class="fas fa-trophy"></i>
                            <div class="palace-stat-content">
                                <strong>Toplam Zafer</strong>
                                <span id="palace-total-wins">0</span>
                            </div>
                        </div>
                        <div class="palace-stat-item">
                            <i class="fas fa-star"></i>
                            <div class="palace-stat-content">
                                <strong>İtibar Puanı</strong>
                                <span id="palace-reputation">0</span>
                            </div>
                        </div>
                         <div class="palace-stat-item">
                            <i class="fas fa-users-cog"></i>
                            <div class="palace-stat-content">
                                <strong>Toplam Gladyatör</strong>
                                <span id="palace-total-gladiators">0</span>
                            </div>
                        </div>
                         <div class="palace-stat-item">
                            <i class="fas fa-skull-crossbones"></i>
                            <div class="palace-stat-content">
                                <strong>Kayıp Gladyatör</strong>
                                <span id="palace-lost-gladiators">0</span>
                            </div>
                        </div>
                    </div>
                     <p style="text-align: center; margin-top: 30px; font-style: italic;">
                        "Roma'nın ihtişamına hizmet etmeye devam et Komutan. Zaferler seni bekliyor!"
                     </p>
                </div>

                <div class="section" id="gladiators">
                    <h2 class="section-title"><i class="fas fa-helmet-battle"></i> Gladyatör Kadrosu</h2>
                    <div class="gladiator-grid" id="gladiator-grid"></div>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary" id="open-recruit-modal-btn">
                            <i class="fas fa-plus"></i> Yeni Gladyatör İşe Al
                        </button>
                    </div>
                </div>

                <div class="section" id="map">
                    <h2 class="section-title"><i class="fas fa-map-marked-alt"></i> Dünya Haritası</h2>
                    <div class="map-grid" id="map-grid">
                        <!-- Harita Konumları Buraya Gelecek -->
                    </div>
                </div>

                <div class="section" id="arena">
                    <div class="arena-container">
                        <h2 class="arena-title"><i class="fas fa-gavel"></i> ARENA DÖVÜŞÜ <i class="fas fa-shield-alt"></i></h2>
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: var(--gold); margin-bottom: 10px;">Mevcut Arena: <span id="current-arena-name">Seçiniz</span></h3>
                            <p style="font-size: 0.9em;"><i class="fas fa-award"></i> Ödüller: <span id="current-arena-rewards"></span></p>
                            <p style="font-size: 0.9em;"><i class="fas fa-user-friends"></i> İzleyiciler: <span id="current-arena-audience">Sıradan Kalabalık</span></p>
                            <p style="font-size: 0.9em;"><i class="fas fa-hand-fist"></i> Dövüş Tipi: <span id="current-arena-type">Normal</span></p>
                        </div>
                        <div class="battle-setup">
                            <div class="gladiator-selector" id="player-selector-box">
                                <h3 style="color: var(--gold); margin-bottom: 15px;">Gladyatörünüz</h3>
                                <select id="player-gladiator-select" class="btn" style="width: 100%;">
                                    <option value="">Gladyatör Seç</option>
                                </select>
                                <div id="player-stats-display" style="margin-top: 15px; text-align: left; font-size: 0.9em;"></div>
                                <div class="health-bar">
                                    <div class="health-fill" id="player-health-bar">
                                        <span class="health-text" id="player-health-text"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="vs-symbol"><i class="fas fa-bolt"></i></div>
                            <div class="gladiator-selector" id="opponent-selector-box">
                                <h3 style="color: var(--gold); margin-bottom: 15px;">Rakip</h3>
                                <select id="opponent-select" class="btn" style="width: 100%;">
                                    <option value="">Rakip Seç</option>
                                </select>
                                <div id="opponent-stats-display" style="margin-top: 15px; text-align: left; font-size: 0.9em;"></div>
                                <div class="health-bar">
                                    <div class="health-fill" id="opponent-health-bar">
                                        <span class="health-text" id="opponent-health-text"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="battle-log" id="battle-log" style="display: none;"></div>
                        <div class="battle-speed-controls">
                            <button class="btn" id="speed-1x-btn" data-speed="1">1x</button>
                            <button class="btn" id="speed-2x-btn" data-speed="2">2x</button>
                            <button class="btn" id="speed-3x-btn" data-speed="3">3x</button>
                            <button class="btn" id="speed-4x-btn" data-speed="4">4x</button>
                        </div>
                        <button class="btn btn-primary" id="start-battle-btn" style="font-size: 1.2em; padding: 15px 30px;" disabled>
                            <i class="fas fa-play"></i> Savaşı Başlat!
                        </button>
                    </div>
                </div>

                <div class="section" id="training">
                     <h2 class="section-title"><i class="fas fa-dumbbell"></i> Gladyatör Eğitim Merkezi</h2>
                    <div style="margin-bottom: 20px; text-align: center;">
                        <label for="training-gladyatör-select" style="color: var(--gold); margin-right: 10px;">Eğitilecek Gladyatör:</label>
                        <select id="training-gladyatör-select" class="btn" style="padding: 8px 15px;">
                            <option value="">Gladyatör Seç</option>
                        </select>
                    </div>
                    <div class="training-grid" id="training-grid"></div>
                </div>

                <div class="section" id="barracks">
                    <h2 class="section-title"><i class="fas fa-bed"></i> Kışla ve İyileşme</h2>
                    <div style="margin-bottom: 20px; text-align: center;">
                        <label for="barracks-gladiator-select" style="color: var(--gold); margin-right: 10px;">Gladyatör Seç:</label>
                        <select id="barracks-gladiator-select" class="btn" style="padding: 8px 15px;">
                             <option value="">Gladyatör Seç</option>
                        </select>
                    </div>
                    <div class="training-grid" id="barracks-grid">
                        <div class="training-option" id="rest-option">
                            <div>
                                <div class="training-icon"><i class="fas fa-campfire"></i></div>
                                <div class="training-name">Dinlen</div>
                                <div style="margin-top: 10px; font-size: 0.9em; color: var(--marble);">Gladyatörünün canının bir kısmını iyileştirir.</div>
                            </div>
                            <div class="training-cost" style="margin-top: 15px;"><i class="fas fa-coins"></i> Ücretsiz</div>
                        </div>
                        <div class="training-option" id="healer-option">
                            <div>
                                <div class="training-icon"><i class="fas fa-hand-holding-medical"></i></div>
                                <div class="training-name">Şifacı</div>
                                <div style="margin-top: 10px; font-size: 0.9em; color: var(--marble);">Gladyatörünün canını tamamen doldurur ve eğer öldüyse canlandırır.</div>
                            </div>
                            <div class="training-cost" style="margin-top: 15px;"><i class="fas fa-coins"></i> <span id="healer-cost"></span> Altın</div>
                        </div>
                    </div>
                </div>

                <div class="section" id="market">
                    <h2 class="section-title"><i class="fas fa-store"></i> İmparatorluk Pazarı</h2>
                    <div class="market-categories" id="market-categories">
                        <!-- Kategori butonları buraya gelecek -->
                    </div>
                    <div class="market-grid" id="market-grid"></div>
                </div>

                <div class="section" id="bank">
                    <h2 class="section-title"><i class="fas fa-bank"></i> İmparatorluk Bankası</h2>
                    <div class="bank-info">
                        <p><i class="fas fa-coins"></i> Bankadaki Altın: <strong id="bank-gold">0</strong></p>
                        <p><i class="fas fa-percent"></i> Faiz Oranı: <strong id="bank-interest-rate">0%</strong></p>
                        <p><i class="fas fa-hand-holding-usd"></i> Biriken Faiz: <strong id="bank-accrued-interest">0</strong></p>
                    </div>
                    <div class="bank-controls">
                        <input type="number" id="bank-amount-input" placeholder="Miktar" min="1">
                        <button class="btn btn-primary" id="bank-deposit-btn"><i class="fas fa-plus-circle"></i> Yatır</button>
                        <button class="btn" id="bank-withdraw-btn"><i class="fas fa-minus-circle"></i> Çek</button>
                        <button class="btn" id="bank-collect-interest-btn"><i class="fas fa-sack-dollar"></i> Faiz Topla</button>
                    </div>
                </div>

                <div class="section" id="quests">
                    <h2 class="section-title"><i class="fas fa-scroll"></i> Senatör Görevleri</h2>
                    <ul class="quest-list" id="quest-list">
                        <!-- Görevler buraya gelecek -->
                    </ul>
                     <p id="no-quests-message" style="text-align: center; color: var(--marble); margin-top: 30px;">
                        Henüz Senato'dan yeni bir görev ulaşmadı. Belki daha fazla ün kazandığında dikkatlerini çekersin...
                        <i class="fas fa-hourglass-half" style="margin-left: 10px;"></i>
                    </p>
                </div>

                <div class="section" id="legends">
                    <h2 class="section-title"><i class="fas fa-medal"></i> Efsanevi Gladyatörler</h2>
                    <div class="legends-grid" id="legends-grid">
                        <!-- Efsanevi Gladyatörler Buraya Gelecek -->
                    </div>
                    <p style="text-align: center; margin-top: 30px; font-style: italic;">
                        Efsaneler nadiren ortaya çıkar ve kadrona katılmaları büyük bir servete mal olabilir!
                    </p>
                </div>

            </section>
            
            <aside class="info-panel">
                <div class="info-section">
                    <h3 class="info-title"><i class="fas fa-newspaper"></i> Haberler</h3>
                    <div class="news-item">İmparator, Colosseum'daki dövüşler için cömert ödüller vaat ediyor!</div>
                    <div class="news-item">Yeni ve egzotik silahlar pazara ulaştı.</div>
                </div>
                 <div class="info-section">
                    <h3 class="info-title"><i class="fas fa-lightbulb"></i> Oyun İpuçları</h3>
                    <div class="news-item">Gladyatörlerini düzenli olarak eğiterek onları daha güçlü yapabilirsin.</div>
                    <div class="news-item">Farklı gladyatör türleri, farklı rakiplere karşı avantajlıdır.</div>
                    <div class="news-item">Gladyatörlerin savaştan sonra yaralı kalır, kışlada dinlenmeyi unutma!</div>
                    <div class="news-item">Gladyatörlerini donatarak savaşta avantaj sağla!</div>
                    <div class="news-item">Envanterindeki eşyaları gladyatör detay penceresinden satabilirsin.</div>
                    <div class="news-item">Her gladyatörün kendine özel yetenekleri olabilir, dikkat et!</div>
                    <div class="news-item">Farklı arenalar farklı zorluklar ve ödüller sunar.</div>
                    <div class="news-item">Bazı arenalarda ünlü kişiler seni izleyebilir ve ekstra bonuslar verebilir!</div>
                    <div class="news-item">Banka, altınlarını güvende tutmak ve faiz kazanmak için harika bir yerdir.</div>
                    <div class="news-item">Eşyalarını yükselterek gladyatörlerine daha da güç kat!</div>
                </div>
                <div class="info-section">
                    <h3 class="info-title"><i class="fas fa-save"></i> Oyun Yönetimi</h3>
                    <button class="btn" onclick="game.saveGame()"><i class="fas fa-save"></i> Oyunu Kaydet</button>
                    <button class="btn" onclick="game.resetGameConfirmation()"><i class="fas fa-sync-alt"></i> Oyunu Sıfırla</button>
                </div>
            </aside>
        </main>
    </div>

    <!-- Yeni Gladyatör İşe Al Modal -->
    <div class="modal-overlay" id="recruit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Yeni Gladyatör İşe Al</h3>
                <button class="modal-close" id="recruit-modal-close-btn">×</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; text-align: center;">Hangi tür gladyatörü kadrona katmak istersin?</p>
                <div class="recruit-options-grid" id="recruit-options-grid">
                    <!-- İşe alım seçenekleri buraya gelecek -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="game.hideRecruitModal()">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Genel Modal (Mevcut) -->
    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title"></h3>
                <button class="modal-close" id="modal-close-btn">×</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer" id="modal-footer"></div>
        </div>
    </div>

    <script>
        // --- YARDIMCI KÜTÜPHANELER ---
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- OYUN AYARLARI (CONFIG) ---
        const CONFIG = {
            SAVE_KEY: 'gladiatorDominus_saveData_v2_9', // Yeni kayıt anahtarı (değişiklikler için sürüm numarası artırıldı)
            initialResources: { gold: 2000, gems: 50, reputation: 0, wins: 0, lostGladiators: 0, currentArena: 'minor_arena_rome' },
            gladiatorNames: ["Spartacus", "Crixus", "Gannicus", "Oenomaus", "Flamma", "Maximus", "Verus", "Priscus", "Carpophorus", "Spiculus", "Aurelius", "Draco", "Brutus", "Varro"],
            gladiatorTypes: ["Murmillo", "Retiarius", "Thraex", "Hoplomachus", "Secutor"],
            gladiatorTraits: [ // Yeni gladyatör özellikleri (pasif beceriler)
                { id: 'aggressive_strike', name: 'Agresif Saldırı', desc: 'Kritik vuruş şansını artırır (+%5).', effect: { critChance: 0.05 } },
                { id: 'iron_skin', name: 'Demir Ten', desc: 'Alınan hasarı azaltır (-1).', effect: { damageReduction: 1 } },
                { id: 'nimble_footwork', name: 'Çevik Ayak', desc: 'Iska/kaçınma şansını artırır (+%2).', effect: { missChanceReduction: 0.02 } }, // missChanceReduction: Düşmanın ıskalama şansını azaltır, yani kendi kaçınma şansını artırır
                { id: 'resilient_spirit', name: 'Dirayetli Ruh', desc: 'Canı düşükken daha fazla hasar verir (Canı %25 veya altındayken +1-3 hasar).', effect: { lowHpDamageBonus: true } },
                { id: 'disciplined_block', name: 'Disiplinli Blok', desc: 'Bazen gelen hasarı tamamen engeller (Düşük şans %5).', effect: { blockChance: 0.05 } },
                { id: 'lucky_strike', name: 'Şanslı Darbe', desc: 'Saldırı isabet oranını artırır (+%3).', effect: { hitChance: 0.03 } },
                { id: 'beast_slayer', name: 'Canavar Katili', desc: 'Hayvanlara karşı +%10 hasar bonusu.', effect: { bonusDamageAgainstAnimals: 0.10 } }
            ],
            recruitmentOptions: { // Yeni gladyatör işe alım seçenekleri
                slave: {
                    name: 'Köle', cost: 150, icon: 'fa-handcuffs', desc: 'Zincirlerinden kurtarılmış bir köle. Düşük başlangıç statları ancak iyi bir eğitimle çok gelişebilir.',
                    baseStats: { str: [3, 7], def: [3, 7], spd: [3, 7], sta: [15, 25] },
                    xpGainMultiplier: 1.2, 
                    traitChance: 0.1, 
                    reputationRequired: 0,
                    levelRequired: 0
                },
                volunteer: {
                    name: 'Gönüllü', cost: 600, icon: 'fa-hand-peace', desc: 'Kaderini kendi belirlemek isteyen özgür bir adam. Dengeli statlar ve gelişim.',
                    baseStats: { str: [6, 10], def: [6, 10], spd: [6, 10], sta: [25, 35] },
                    xpGainMultiplier: 1.0,
                    traitChance: 0.25,
                    reputationRequired: 50, 
                    levelRequired: 3 
                },
                soldier: {
                    name: 'Eski Asker', cost: 1200, icon: 'fa-user-ninja', desc: 'Roma lejyonlarından emekli olmuş tecrübeli bir savaşçı. Yüksek başlangıç statları, ancak yavaş gelişim.',
                    baseStats: { str: [9, 14], def: [9, 14], spd: [9, 14], sta: [35, 45] },
                    xpGainMultiplier: 0.8,
                    traitChance: 0.5, 
                    reputationRequired: 150, 
                    levelRequired: 7 
                }
            },
            famousGladiators: { // Yeni: Ünlü Gladyatörler
                theron: {
                    id: 'theron', name: 'Korkunç Theron', type: 'Thraex', cost: {gold: 2500, gems: 50}, icon: 'fa-user-injured',
                    stats: { str: 20, def: 18, spd: 18, sta: 70 },
                    traits: ['aggressive_strike', 'iron_skin'],
                    description: 'Arenaların en acımasızı. Yenilmez lakabıyla anılır.',
                    levelRequired: 10, repRequired: 250
                },
                vorenus: {
                    id: 'vorenus', name: 'Aslan Yürekli Vorenus', type: 'Murmillo', cost: {gold: 5000, gems: 100}, icon: 'fa-hand-fist',
                    stats: { str: 25, def: 20, spd: 15, sta: 80 },
                    traits: ['disciplined_block', 'resilient_spirit', 'iron_skin'],
                    description: 'Tek başına bir lejyon kadar güçlü, gerçek bir savaş makinesi.',
                    levelRequired: 15, repRequired: 450
                }
            },
            gladiatorSellValueMultiplier: { // Gladyatör satış fiyatı çarpanları
                base: 0.2, // Temel maliyetin %'si
                perLevel: 10, // Her seviye için ekstra altın
                perWin: 5, // Her zafer için ekstra altın
                perTrait: 50 // Her özellik için ekstra altın
            },
            gladiatorDeathPayout: 100, // Gladyatör öldüğünde verilen altın
            training: {
                strength: { name: 'Güç Antrenmanı', cost: 100, increase: 1, icon: 'fa-fist-raised', desc: 'Saldırı gücünü artırır.', successChance: 0.95 },
                defense:  { name: 'Savunma Antrenmanı', cost: 100, increase: 1, icon: 'fa-shield-alt', desc: 'Hasar azaltmayı artırır.', successChance: 0.95 },
                speed:    { name: 'Hız Antrenmanı', cost: 120, increase: 1, icon: 'fa-running', desc: 'İlk saldırma şansını ve isabet/kaçınma şansını artırır.', successChance: 0.90 },
                stamina:  { name: 'Dayanıklılık Antrenmanı', cost: 80, increase: 5, icon: 'fa-heartbeat', desc: 'Maksimum can puanını artırır.', successChance: 0.98 },
                trait_learn: { name: 'Özel Beceri Eğitimi', cost: 500, increase: 0, icon: 'fa-brain', desc: 'Gladyatörüne yeni bir pasif beceri kazandırmaya çalışır.', successChance: 0.60 } 
            },
            healingOptions: {
                rest: { name: 'Dinlen', cost: 0, healPercent: 0.25, icon: 'fa-campfire', desc: 'Gladyatörün canının %25ini iyileştirir.' },
                healer: { name: 'Şifacı', baseCost: 150, healPercent: 1.0, icon: 'fa-hand-holding-medical', desc: 'Gladyatörün canını tamamen doldurur ve eğer öldüyse canlandırır.' }
            },
            bank: {
                interestRate: 0.05, // %5 faiz oranı
                maxInterestPerCollection: 500 // Tek seferde toplanabilecek maksimum faiz
            },
            opponents: {
                weak:     { name: 'Zayıf Rakip', stats: { str: [5, 8], def: [5, 8], spd: [5, 8], sta: [20, 25] }, isAnimal: false },
                medium:   { name: 'Orta Seviye', stats: { str: [8, 12], def: [8, 12], spd: [8, 12], sta: [25, 35] }, isAnimal: false },
                strong:   { name: 'Güçlü Rakip', stats: { str: [12, 16], def: [12, 16], spd: [12, 16], sta: [35, 45] }, isAnimal: false },
                champion: { name: 'Şampiyon', stats: { str: [16, 20], def: [16, 20], spd: [16, 20], sta: [45, 60] }, isAnimal: false },
                famous_theron_opponent: { name: 'Korkunç Theron', stats: { str: [18, 22], def: [15, 18], spd: [15, 18], sta: [50, 70] }, isAnimal: false, isBoss: true }, // Ünlü gladyatör
                lion:     { name: 'Vahşi Aslan', stats: { str: [10, 15], def: [5, 10], spd: [10, 15], sta: [30, 40] }, isAnimal: true }, // Hayvan
                bear:     { name: 'Acımasız Ayı', stats: { str: [12, 18], def: [8, 12], spd: [8, 12], sta: [40, 50] }, isAnimal: true }, // Hayvan
                // Grup dövüşleri için özel rakipler
                group_combat_opponent_1: { name: 'Lejyoner 1', stats: { str: [7,10], def: [7,10], spd: [7,10], sta: [20,30]}, isAnimal: false},
                group_combat_opponent_2: { name: 'Lejyoner 2', stats: { str: [8,11], def: [8,11], spd: [8,11], sta: [25,35]}, isAnimal: false},
                group_combat_opponent_3: { name: 'Lejyoner 3', stats: { str: [9,12], def: [9,12], spd: [9,12], sta: [30,40]}, isAnimal: false},
            },
            locations: { // Yeni konum ve arena sistemi
                rome: {
                    name: 'Roma',
                    icon: 'fas fa-city',
                    description: 'İmparatorluğun kalbi. En büyük arenalara ev sahipliği yapar.',
                    reputationRequired: 0,
                    arenas: {
                        minor_arena_rome: {
                            name: 'Minör Arena',
                            levelRequired: 0,
                            type: 'regular', 
                            audience: 'Sıradan Kalabalık',
                            opponents: ['weak', 'medium'],
                            reward: { gold: 75, rep: 8, xp: 30 },
                            specialGuestChance: 0,
                        },
                        colosseum_rome: {
                            name: 'Colosseum',
                            levelRequired: 5,
                            type: 'tournament',
                            audience: 'Senatörler ve Halk',
                            opponents: ['medium', 'strong', 'champion'],
                            reward: { gold: 250, rep: 25, xp: 80 },
                            specialGuestChance: 0.2, 
                            specialGuest: { name: 'Senatör Brutus', bonusRep: 10, bonusGold: 50 }
                        }
                    }
                },
                capua: {
                    name: 'Capua',
                    icon: 'fas fa-gopuram',
                    description: 'Gladyatör okullarıyla ünlü kadim şehir. Sert dövüşler burada başlar.',
                    reputationRequired: 100, 
                    arenas: {
                        training_grounds_capua: {
                            name: 'Eğitim Arenası',
                            levelRequired: 0, // This arena is generally for early game, so no high level requirement
                            type: 'regular',
                            audience: 'Yerel Seyirci',
                            opponents: ['weak'],
                            reward: { gold: 40, rep: 3, xp: 15 },
                            specialGuestChance: 0,
                        },
                        grand_arena_capua: {
                            name: 'Büyük Arena',
                            levelRequired: 8,
                            type: 'animal_fight', 
                            audience: 'Zengin Tüccarlar',
                            opponents: ['lion', 'bear'], 
                            reward: { gold: 400, rep: 40, xp: 120 },
                            specialGuestChance: 0.1,
                            specialGuest: { name: 'Zengin Tüccar Marcus', bonusGold: 100 }
                        }
                    }
                },
                pompeii: {
                    name: 'Pompeii',
                    icon: 'fas fa-volcano',
                    description: 'Vezüv gölgesindeki canlı şehir. Ölümcül dövüşlere ev sahipliği yapar.',
                    reputationRequired: 250,
                    arenas: {
                        amphitheatre_pompeii: {
                            name: 'Pompeii Amfitiyatrosu',
                            levelRequired: 12,
                            type: 'group_combat', 
                            audience: 'Coşkulu Kalabalık',
                            opponents: ['group_combat_opponent_1', 'group_combat_opponent_2', 'group_combat_opponent_3'], 
                            reward: { gold: 600, rep: 60, xp: 180 },
                            specialGuestChance: 0.15,
                            specialGuest: { name: 'Praetor Lucius', bonusRep: 15 }
                        }
                    }
                },
                 alexandria: {
                    name: 'İskenderiye',
                    icon: 'fas fa-lighthouse',
                    description: 'Mısır\'ın mistik şehri, güçlü ve egzotik rakiplerle dolu.',
                    reputationRequired: 500,
                    arenas: {
                        pharos_arena: {
                            name: 'Pharos Arenası',
                            levelRequired: 18,
                            type: 'famous_gladiator_challenge',
                            audience: 'İmparatorluk Elitleri',
                            opponents: ['famous_theron_opponent'], 
                            reward: { gold: 1000, rep: 100, xp: 300 },
                            specialGuestChance: 0.5,
                            specialGuest: { name: 'İmparator Nero', bonusGold: 500, bonusGems: 20 }
                        }
                    }
                },
                antioch: {
                    name: 'Antakya',
                    icon: 'fas fa-archway',
                    description: 'Doğu\'nun incisi, lejyonların ve tüccarların kavşak noktası.',
                    reputationRequired: 750,
                    arenas: {
                        hippodrome_antioch: {
                            name: 'Antakya Hipodromu',
                            levelRequired: 22,
                            type: 'tournament',
                            audience: 'Doğulu Sultanlar',
                            opponents: ['strong', 'champion', 'famous_theron_opponent'],
                            reward: { gold: 1500, rep: 150, xp: 400 },
                            specialGuestChance: 0.3,
                            specialGuest: { name: 'Kraliçe Zenobia', bonusGold: 300, bonusGems: 10 }
                        }
                    }
                },
                carthage: {
                    name: 'Kartaca',
                    icon: 'fas fa-ship',
                    description: 'Kuzey Afrika\'nın efsanevi liman şehri. Kadim düşmanlıkların izleri hala duruyor.',
                    reputationRequired: 1000,
                    arenas: {
                        carthage_coliseum: {
                            name: 'Kartaca Kolezyumu',
                            levelRequired: 25,
                            type: 'group_combat',
                            audience: 'Kartacalı Lordlar',
                            opponents: ['famous_theron_opponent', 'group_combat_opponent_1', 'group_combat_opponent_2'],
                            reward: { gold: 2000, rep: 200, xp: 500 },
                            specialGuestChance: 0.4,
                            specialGuest: { name: 'General Hannibal\'ın Torunu', bonusGold: 500, bonusGems: 25 }
                        }
                    }
                }
            },
            items: {
                gladius: { name: 'Gladius', type: 'weapon', cost: 150, sellValue: 75, icon: 'fa-gavel', rarity: 'common', bonus: { strength: 3, speed: 1 }, maxLevel: 5, upgradeCost: {gold: 50, gems: 0}, stock: 5 },
                scutum:  { name: 'Scutum', type: 'armor', cost: 120, sellValue: 60, icon: 'fa-shield-alt', rarity: 'common', bonus: { defense: 2, stamina: 5 }, maxLevel: 5, upgradeCost: {gold: 40, gems: 0}, stock: 5 },
                galea:   { name: 'Galea', type: 'helmet', cost: 100, sellValue: 50, icon: 'fa-helmet-battle', rarity: 'common', bonus: { defense: 1, stamina: 2 }, maxLevel: 5, upgradeCost: {gold: 30, gems: 0}, stock: 5 },
                healing_potion: { name: 'Can İksiri', type: 'consumable', cost: 75, sellValue: 30, icon: 'fa-flask', rarity: 'common', healAmount: 25, stock: 7 },
                heavy_armor: { name: 'Ağır Zırh', type: 'armor', cost: 300, sellValue: 150, icon: 'fa-user-shield', rarity: 'uncommon', bonus: { defense: 4, stamina: 10, speed: -1 }, maxLevel: 5, upgradeCost: {gold: 80, gems: 0}, stock: 3 },
                long_sword: { name: 'Uzun Kılıç', type: 'weapon', cost: 250, sellValue: 125, icon: 'fa-sword', rarity: 'uncommon', bonus: { strength: 5 }, maxLevel: 5, upgradeCost: {gold: 70, gems: 0}, stock: 3 },
                aegis_shield: { name: 'Aegis Kalkanı', type: 'armor', cost: 600, sellValue: 300, icon: 'fa-shield-alt', rarity: 'rare', bonus: { defense: 6, stamina: 15, strength: 1 }, maxLevel: 5, upgradeCost: {gold: 150, gems: 1}, stock: 2 },
                spartans_helmet: { name: 'Spartan Miğferi', type: 'helmet', cost: 400, sellValue: 200, icon: 'fa-hat-helmet', rarity: 'rare', bonus: { defense: 3, stamina: 5, speed: 1 }, maxLevel: 5, upgradeCost: {gold: 100, gems: 1}, stock: 2 },
                tyrants_blade: { name: 'Tiranın Kılıcı', type: 'weapon', cost: 1200, sellValue: 600, icon: 'fa-hand-fist', rarity: 'epic', bonus: { strength: 8, speed: 2, critChance: 0.05 }, maxLevel: 5, upgradeCost: {gold: 300, gems: 2}, stock: 1 },
                lionheart_cuirass: { name: 'Aslan Yürekli Zırh', type: 'armor', cost: 1000, sellValue: 500, icon: 'fa-shirt', rarity: 'epic', bonus: { defense: 8, stamina: 20, damageReduction: 0.5 }, maxLevel: 5, upgradeCost: {gold: 250, gems: 2}, stock: 1 },
                // Yeni Eklenen Eşyalar
                katana: { name: 'Katana', type: 'weapon', cost: 800, sellValue: 400, icon: 'fa-fan', rarity: 'rare', bonus: { strength: 6, speed: 3, critChance: 0.02 }, maxLevel: 5, upgradeCost: {gold: 200, gems: 1}, stock: 2 }, 
                greatsword: { name: 'Büyük Kılıç', type: 'weapon', cost: 1500, sellValue: 750, icon: 'fa-hand-holding-medical', rarity: 'epic', bonus: { strength: 10, defense: -2, speed: -1 }, maxLevel: 5, upgradeCost: {gold: 400, gems: 2}, stock: 1 }, 
                tower_shield: { name: 'Kule Kalkanı', type: 'armor', cost: 700, sellValue: 350, icon: 'fa-square-shield', rarity: 'rare', bonus: { defense: 7, stamina: 10, speed: -2 }, maxLevel: 5, upgradeCost: {gold: 180, gems: 1}, stock: 2 }, 
                buckler: { name: 'Buckler', type: 'armor', cost: 300, sellValue: 150, icon: 'fa-circle-shield', rarity: 'uncommon', bonus: { defense: 1, speed: 3, missChanceReduction: 0.01 }, maxLevel: 5, upgradeCost: {gold: 75, gems: 0}, stock: 3 }, 
                centurion_helmet: { name: 'Lejyoner Miğferi', type: 'helmet', cost: 500, sellValue: 250, icon: 'fa-helmet-battle', rarity: 'uncommon', bonus: { strength: 1, defense: 2, stamina: 3 }, maxLevel: 5, upgradeCost: {gold: 120, gems: 0}, stock: 3 }, 
                greater_healing_potion: { name: 'Büyük Can İksiri', type: 'consumable', cost: 150, sellValue: 60, icon: 'fa-flask-round-potion', rarity: 'uncommon', healAmount: 50, stock: 5 },
                celestial_blade: { name: 'Göksel Kılıç', type: 'weapon', cost: 3000, sellValue: 1500, icon: 'fa-sparkles', rarity: 'legendary', bonus: { strength: 12, speed: 4, critChance: 0.08, hitChance: 0.05 }, maxLevel: 5, upgradeCost: {gold: 800, gems: 5}, stock: 1 }, 
                titan_shield: { name: 'Titan Kalkanı', type: 'armor', cost: 2500, sellValue: 1250, icon: 'fa-block-brick', rarity: 'legendary', bonus: { defense: 10, stamina: 30, damageReduction: 1.0 }, maxLevel: 5, upgradeCost: {gold: 700, gems: 5}, stock: 1 } 
            },
            combat: {
                CRIT_CHANCE: 0.15, 
                MISS_CHANCE_BASE: 0.10, 
                MISS_CHANCE_SPEED_FACTOR: 0.005, 
                LEVEL_UP_XP_MULTIPLIER: 100, 
                LEVEL_UP_STAT_BONUS_MIN: 1,
                LEVEL_UP_STAT_BONUS_MAX: 2,
                LEVEL_UP_STAMINA_BONUS_MIN: 3,
                LEVEL_UP_STAMINA_BONUS_MAX: 5,
                DEATH_DEFY_CHANCE: 0.05 
            },
            quests: { 
                arena_win_minor: {
                    id: 'arena_win_minor', name: 'Küçük Arena Şampiyonu', description: 'Roma Minör Arena\'da bir dövüş kazan.',
                    target: { type: 'win_arena', arenaKey: 'minor_arena_rome' }, rewards: { gold: 100, rep: 10, xp_bonus: 50 }, status: 'available', reputationRequired: 0
                },
                train_gladiator_strength: {
                    id: 'train_gladiator_strength', name: 'Güçlü Bir Gladyatör', description: 'Herhangi bir gladyatöre 3 kez güç antrenmanı yaptır.',
                    target: { type: 'train_stat', stat: 'strength', amount: 3 }, rewards: { gold: 75, xp_bonus: 30, gems: 5 }, status: 'available', progress: 0, reputationRequired: 10
                },
                recruit_slave: {
                    id: 'recruit_slave', name: 'Özgürlük Savaşçısı', description: 'Bir köle gladyatör işe al.',
                    target: { type: 'recruit_type', gladiatorType: 'slave' }, rewards: { gold: 50, rep: 5 }, status: 'available', reputationRequired: 0
                },
                 purchase_armor: {
                    id: 'purchase_armor', name: 'Demir Cilt', description: 'Pazardan herhangi bir zırh satın al.',
                    target: { type: 'buy_item_type', itemType: 'armor' }, rewards: { gold: 50, gems: 2 }, status: 'available', reputationRequired: 20
                },
                learn_trait: {
                    id: 'learn_trait', name: 'Gizli Yetenek', description: 'Bir gladyatörüne özel bir beceri eğitimi vererek yeni bir yetenek öğrenmesini sağla.',
                    target: { type: 'learn_trait' }, rewards: { gold: 200, rep: 20, gems: 10 }, status: 'available', reputationRequired: 50
                },
                win_colosseum: {
                    id: 'win_colosseum', name: 'Colosseum Şampiyonu', description: 'Roma Colosseum\'da bir dövüş kazan.',
                    target: { type: 'win_arena', arenaKey: 'colosseum_rome' }, rewards: { gold: 500, rep: 50, gems: 15 }, status: 'available', reputationRequired: 75
                },
                defeat_theron: {
                    id: 'defeat_theron', name: 'Theron\'un Düşüşü', description: 'İskenderiye Pharos Arenası\'nda Korkunç Theron\'u yen.',
                    target: { type: 'defeat_famous_gladiator', gladiatorId: 'famous_theron_opponent' }, rewards: { gold: 1000, rep: 100, gems: 30 }, status: 'available', reputationRequired: 450 
                },
                buy_rare_item: {
                    id: 'buy_rare_item', name: 'Nadir Koleksiyoncu', description: 'Pazardan nadir (rare) kalitede bir eşya satın al.',
                    target: { type: 'buy_item_rarity', rarity: 'rare' }, rewards: { gold: 250, gems: 5 }, status: 'available', reputationRequired: 100
                },
                upgrade_item_level_3: {
                    id: 'upgrade_item_level_3', name: 'Usta Demircisi', description: 'Herhangi bir eşyayı en az 3. seviyeye yükselt.',
                    target: { type: 'item_upgrade_level', level: 3 }, rewards: { gold: 300, rep: 30 }, status: 'available', progress: 0, reputationRequired: 150
                },
                bank_gold: {
                    id: 'bank_gold', name: 'Zenginlik Yığma', description: 'Bankaya toplam 1000 altın yatır (toplam birikmiş miktar).',
                    target: { type: 'bank_total_deposit', amount: 1000 }, rewards: { gold: 150, gems: 5 }, status: 'available', progress: 0, reputationRequired: 0
                },
                win_animal_fight: {
                    id: 'win_animal_fight', name: 'Canavar Terbiyecisi', description: 'Capua Büyük Arena\'da bir hayvan dövüşü kazan.',
                    target: { type: 'win_arena', arenaKey: 'grand_arena_capua' }, rewards: { gold: 300, rep: 30, xp_bonus: 80 }, status: 'available', reputationRequired: 120
                },
                win_group_combat: {
                    id: 'win_group_combat', name: 'Kitle İmha Silahı', description: 'Pompeii Amfitiyatrosu\'nda bir grup dövüşü kazan.',
                    target: { type: 'win_arena', arenaKey: 'amphitheatre_pompeii' }, rewards: { gold: 500, rep: 50, gems: 10 }, status: 'available', reputationRequired: 300
                }
            }
        };

        // --- NESNE SINIFLARI (Daha az yer kaplayan ve kaliteli kod) ---
        class Item {
            constructor(id, name, type, cost, sellValue, icon, rarity = 'common', bonus = {}, healAmount = 0, level = 0, maxLevel = 0, upgradeCost = {gold: 0, gems: 0}, stock = 1) {
                Object.assign(this, { id, name, type, cost, sellValue, icon, rarity, bonus, healAmount, level, maxLevel, upgradeCost, stock });
            }

            getBonusString() {
                const bonuses = [];
                // Stat bonuslarını dahil et
                for (const stat in this.bonus) {
                    const val = this.bonus[stat];
                    if (typeof val === 'number' && val !== 0) { // Sadece sayısal değerleri ve sıfır olmayanları dahil et
                        let displayVal = val;
                        let statName = stat.charAt(0).toUpperCase() + stat.slice(1);
                        if (stat === 'critChance' || stat === 'missChanceReduction' || stat === 'hitChance' || stat === 'blockChance' || stat === 'bonusDamageAgainstAnimals') {
                            displayVal = (val * 100).toFixed(0) + '%';
                            if (stat === 'critChance') statName = 'Kritik';
                            else if (stat === 'missChanceReduction') statName = 'Kaçınma';
                            else if (stat === 'hitChance') statName = 'İsabet';
                            else if (stat === 'blockChance') statName = 'Blok';
                            else if (stat === 'bonusDamageAgainstAnimals') statName = 'Hayvan Hsr.';
                        }
                        bonuses.push(${displayVal > 0 ? '+' : ''}${displayVal} ${statName});
                    }
                }
                // İksir iyileşme miktarını dahil et
                if (this.type === 'consumable' && this.healAmount > 0) bonuses.push(+${this.healAmount} Can);
                return bonuses.length ? (${bonuses.join(', ')}) : '';
            }

            toPlainObject() { return { ...this }; } // Basitçe tüm özellikleri kopyala
            static fromPlainObject(obj) {
                // Varsayılan değerler için nullish coalescing (??) operatörü kullanılır, undefined kontrolü için daha kısa
                const { id, name, type, cost, sellValue, icon, rarity = 'common', bonus = {}, healAmount = 0, level = 0, maxLevel, upgradeCost = {gold: 0, gems: 0}, stock = 1 } = obj;
                // maxLevel için özel mantık: Eğer undefined ise consumable olmayanlar için 5, consumable için 0
                const finalMaxLevel = maxLevel ?? (type === 'consumable' ? 0 : 5);
                return new Item(id, name, type, cost, sellValue, icon, rarity, bonus, healAmount, level, finalMaxLevel, upgradeCost, stock);
            }
        }

        class Gladiator {
            constructor(id, name, type, strength, defense, speed, stamina, currentHp = null, level = 1, xp = 0, isAlive = true, equippedItems = {}, traits = [], wins = 0, losses = 0) {
                Object.assign(this, { id, name, type, level, xp, strength, defense, speed, stamina, currentHp: currentHp ?? stamina, isAlive, wins, losses });
                this.equippedItems = {
                    weapon: equippedItems?.weapon ? Item.fromPlainObject(equippedItems.weapon) : null,
                    armor: equippedItems?.armor ? Item.fromPlainObject(equippedItems.armor) : null,
                    helmet: equippedItems?.helmet ? Item.fromPlainObject(equippedItems.helmet) : null,
                };
                this.traits = (traits || []).map(tId => CONFIG.gladiatorTraits.find(gt => gt.id === tId)).filter(Boolean);
            }

            getEffectiveStat(statName) {
                let baseStat = this[statName];
                for (const slot in this.equippedItems) {
                    const item = this.equippedItems[slot];
                    if (item?.bonus?.[statName] !== undefined && typeof item.bonus[statName] === 'number') {
                        baseStat += item.bonus[statName]; // Item bonusu direkt eklenir
                        if (item.level > 0) { // Seviye bonusu eklenir
                            baseStat += (item.bonus[statName] * 0.1) * item.level; // Her seviye için %10 artış
                        }
                    }
                }
                this.traits.forEach(trait => {
                    if (trait?.effect?.[statName] !== undefined && typeof trait.effect[statName] === 'number') {
                        baseStat += trait.effect[statName];
                    }
                });
                return Math.max(statName === 'stamina' ? 1 : 0, Math.round(baseStat));
            }

            getEffectiveCritChance() {
                let chance = CONFIG.combat.CRIT_CHANCE;
                for (const slot in this.equippedItems) if (this.equippedItems[slot]?.bonus?.critChance) chance += this.equippedItems[slot].bonus.critChance * (1 + this.equippedItems[slot].level * 0.02);
                this.traits.forEach(t => { if (t?.effect?.critChance) chance += t.effect.critChance; });
                return Math.min(1, chance);
            }
            getEffectiveDamageReduction() {
                let reduction = 0;
                for (const slot in this.equippedItems) if (this.equippedItems[slot]?.bonus?.damageReduction) reduction += this.equippedItems[slot].bonus.damageReduction * (1 + this.equippedItems[slot].level * 0.05);
                this.traits.forEach(t => { if (t?.effect?.damageReduction) reduction += t.effect.damageReduction; });
                return reduction;
            }
            getEffectiveMissChanceReduction() { // This is enemy's miss chance reduction (i.e., your dodge chance increase)
                let reduction = 0;
                this.traits.forEach(t => { if (t?.effect?.missChanceReduction) reduction += t.effect.missChanceReduction; });
                return reduction;
            }
            getEffectiveBlockChance() {
                let chance = 0;
                this.traits.forEach(t => { if (t?.effect?.blockChance) chance += t.effect.blockChance; });
                return Math.min(1, chance);
            }
            getEffectiveHitChance() {
                let chance = 0;
                this.traits.forEach(t => { if (t?.effect?.hitChance) chance += t.effect.hitChance; });
                return chance;
            }
            getBonusDamageAgainstAnimals() {
                let bonus = 0;
                this.traits.forEach(t => { if (t?.effect?.bonusDamageAgainstAnimals) bonus += t.effect.bonusDamageAgainstAnimals; });
                return bonus;
            }

            takeDamage(amount) {
                if (!this.isAlive) return; // Zaten ölü ise hasar almaz
                let actualDamage = Math.max(0, amount - this.getEffectiveDamageReduction());
                if (this.hasTrait('disciplined_block') && Math.random() < this.getEffectiveBlockChance()) {
                    game.battleLog(<strong>${this.name}</strong> gelen hasarı tamamen engelledi! <i class="fas fa-shield-alt"></i>, 'info'); actualDamage = 0;
                }
                this.currentHp = Math.max(0, this.currentHp - actualDamage);
                if (this.currentHp === 0) {
                    if (Math.random() < CONFIG.combat.DEATH_DEFY_CHANCE) {
                        this.currentHp = 1; game.battleLog(<strong>${this.name}</strong> ölümden kıl payı kurtuldu! <i class="fas fa-heart-pulse"></i>, 'info');
                    } else {
                        this.isAlive = false; game.state.lostGladiators++; game.state.gold += CONFIG.gladiatorDeathPayout;
                        game.showNotification(<i class="fas fa-skull-crossbones"></i> <strong>${this.name}</strong> arenada hayatını kaybetti! (+${CONFIG.gladiatorDeathPayout} altın), 'error');
                    }
                }
            }

            heal(amount) { if (!this.isAlive) { this.isAlive = true; this.currentHp = 0; } this.currentHp = Math.min(this.getEffectiveStat('stamina'), this.currentHp + amount); }
            canBeHealedByRest() { return this.isAlive && this.currentHp < this.getEffectiveStat('stamina'); }
            canBeHealedByHealer() { return this.currentHp < this.getEffectiveStat('stamina') || !this.isAlive; } // Canı tam değilse veya ölü ise iyileştirilebilir
            
            gainXP(amount, xpMultiplier = 1) {
                if (!this.isAlive) return;
                this.xp += amount * xpMultiplier;
                while (this.xp >= this.level * CONFIG.combat.LEVEL_UP_XP_MULTIPLIER) {
                    this.xp -= this.level * CONFIG.combat.LEVEL_UP_XP_MULTIPLIER; this.levelUp();
                }
            }
            levelUp() {
                this.level++;
                ['strength', 'defense', 'speed'].forEach(stat => this[stat] += game.getRandom(CONFIG.combat.LEVEL_UP_STAT_BONUS_MIN, CONFIG.combat.LEVEL_UP_STAT_BONUS_MAX));
                this.stamina += game.getRandom(CONFIG.combat.LEVEL_UP_STAMINA_BONUS_MIN, CONFIG.combat.LEVEL_UP_STAMINA_BONUS_MAX);
                this.currentHp = this.getEffectiveStat('stamina'); // Canı seviye atlayınca dolar
                game.showNotification(<i class="fas fa-arrow-up"></i> <strong>${this.name}</strong> seviye atladı! Yeni seviye: ${this.level}, 'success');
            }

            equipItem(item) { if (['weapon', 'armor', 'helmet'].includes(item.type)) { this.equippedItems[item.type] = item; return true; } return false; }
            unequipItem(itemType) { const unequipped = this.equippedItems[itemType]; this.equippedItems[itemType] = null; return unequipped; }
            hasTrait(traitId) { return this.traits.some(t => t.id === traitId); }
            addTrait(traitId) { const trait = CONFIG.gladiatorTraits.find(t => t.id === traitId); if (trait && !this.hasTrait(trait.id)) { this.traits.push(trait); return true; } return false; }

            toPlainObject() {
                return { ...this, equippedItems: { weapon: this.equippedItems.weapon?.toPlainObject() || null, armor: this.equippedItems.armor?.toPlainObject() || null, helmet: this.equippedItems.helmet?.toPlainObject() || null }, traits: this.traits.map(t => t.id) };
            }
            static fromPlainObject(obj) {
                const { id, name, type, strength, defense, speed, stamina, currentHp, level, xp, isAlive, equippedItems, traits, wins = 0, losses = 0 } = obj;
                return new Gladiator(id, name, type, strength, defense, speed, stamina, currentHp, level, xp, isAlive, equippedItems, traits, wins, losses);
            }
        }

        class Game {
            constructor() {
                // DOM elementlerini açıkça ve doğru ID'lerle seçme
                this.dom = {
                    loadingOverlay: document.getElementById('loading-overlay'),
                    goldVal: document.getElementById('gold-val'),
                    gemsVal: document.getElementById('gems-val'),
                    reputationVal: document.getElementById('reputation-val'),
                    navMenu: document.getElementById('nav-menu'),
                    sections: document.querySelectorAll('.section'),

                    palaceTotalWins: document.getElementById('palace-total-wins'),
                    palaceReputation: document.getElementById('palace-reputation'),
                    palaceTotalGladiators: document.getElementById('palace-total-gladiators'),
                    palaceLostGladiators: document.getElementById('palace-lost-gladiators'),

                    gladiatorGrid: document.getElementById('gladiator-grid'),
                    openRecruitModalBtn: document.getElementById('open-recruit-modal-btn'),

                    mapGrid: document.getElementById('map-grid'),

                    currentArenaName: document.getElementById('current-arena-name'),
                    currentArenaRewards: document.getElementById('current-arena-rewards'),
                    currentArenaAudience: document.getElementById('current-arena-audience'),
                    currentArenaType: document.getElementById('current-arena-type'),
                    playerSelect: document.getElementById('player-gladiator-select'),
                    opponentSelect: document.getElementById('opponent-select'),
                    playerStats: document.getElementById('player-stats-display'),
                    opponentStats: document.getElementById('opponent-stats-display'),
                    playerHealthBar: document.getElementById('player-health-bar'),
                    playerHealthText: document.getElementById('player-health-text'),
                    opponentHealthBar: document.getElementById('opponent-health-bar'),
                    opponentHealthText: document.getElementById('opponent-health-text'),
                    startBattleBtn: document.getElementById('start-battle-btn'),
                    battleLog: document.getElementById('battle-log'),
                    playerSelectorBox: document.getElementById('player-selector-box'),
                    opponentSelectorBox: document.getElementById('opponent-selector-box'),
                    speedButtons: document.querySelectorAll('.battle-speed-controls .btn'),

                    trainingSelect: document.getElementById('training-gladyatör-select'), 
                    trainingGrid: document.getElementById('training-grid'),

                    barracksSelect: document.getElementById('barracks-gladiator-select'),
                    barracksGrid: document.getElementById('barracks-grid'),
                    healerCost: document.getElementById('healer-cost'),
                    restOption: document.getElementById('rest-option'), 
                    healerOption: document.getElementById('healer-option'), 

                    marketGrid: document.getElementById('market-grid'),
                    marketCategories: document.getElementById('market-categories'),

                    bankGold: document.getElementById('bank-gold'),
                    bankInterestRate: document.getElementById('bank-interest-rate'),
                    bankAccruedInterest: document.getElementById('bank-accrued-interest'),
                    bankAmountInput: document.getElementById('bank-amount-input'),
                    bankDepositBtn: document.getElementById('bank-deposit-btn'),
                    bankWithdrawBtn: document.getElementById('bank-withdraw-btn'),
                    bankCollectInterestBtn: document.getElementById('bank-collect-interest-btn'),

                    questList: document.getElementById('quest-list'),
                    noQuestsMessage: document.getElementById('no-quests-message'),

                    legendsGrid: document.getElementById('legends-grid'),

                    modal: document.getElementById('modal'),
                    modalTitle: document.getElementById('modal-title'),
                    modalBody: document.getElementById('modal-body'),
                    modalFooter: document.getElementById('modal-footer'),
                    modalCloseBtn: document.getElementById('modal-close-btn'),

                    recruitModal: document.getElementById('recruit-modal'),
                    recruitModalCloseBtn: document.getElementById('recruit-modal-close-btn'),
                    recruitOptionsGrid: document.getElementById('recruit-options-grid'),
                    
                    notificationContainer: document.getElementById('notification-container')
                };

                this.state = {}; this.isBattleInProgress = false; this.selectedGladiatorIdForModal = null;
                this.battleSpeedMultiplier = 1; this.currentMarketCategory = 'all';
            }

            getRandom = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            getRandomItem = arr => arr[this.getRandom(0, arr.length - 1)];
            delay = ms => new Promise(res => setTimeout(res, ms / this.battleSpeedMultiplier));
            
            showNotification(message, type = 'success') {
                if (!this.dom.notificationContainer) { console.error("Notification container not found!"); return; }
                const notification = document.createElement('div');
                notification.className = notification ${type}; notification.innerHTML = message;
                this.dom.notificationContainer.appendChild(notification);
                setTimeout(() => notification.remove(), 4000);
            }

            showModal(title, body, footerButtons = []) {
                if (!this.dom.modal || !this.dom.modalTitle || !this.dom.modalBody || !this.dom.modalFooter) { console.error("Modal elements not found!"); return; }
                this.dom.modalTitle.innerHTML = title; this.dom.modalBody.innerHTML = body; this.dom.modalFooter.innerHTML = '';
                footerButtons.forEach(btnConfig => {
                    const button = document.createElement('button');
                    Object.assign(button, { className: btn ${btnConfig.class || ''}, innerHTML: btnConfig.text, onclick: () => { btnConfig.action(); if (btnConfig.shouldCloseModal !== false) this.hideModal(); } });
                    this.dom.modalFooter.appendChild(button);
                });
                this.dom.modal.classList.add('show');
            }
            hideModal() { if(this.dom.modal) this.dom.modal.classList.remove('show'); this.selectedGladiatorIdForModal = null; }
            showRecruitModal() { if(this.dom.recruitModal) { this.renderRecruitOptions(); this.dom.recruitModal.classList.add('show'); }}
            hideRecruitModal() { if(this.dom.recruitModal) this.dom.recruitModal.classList.remove('show'); }

            saveGame() {
                const plainState = {
                    ...this.state,
                    gladiators: this.state.gladiators.map(g => g.toPlainObject()),
                    inventory: this.state.inventory.map(i => i.toPlainObject()),
                    quests: Object.fromEntries(Object.entries(this.state.quests).map(([id, quest]) => [id, { ...quest, target: quest.target }]))
                };
                localStorage.setItem(CONFIG.SAVE_KEY, JSON.stringify(plainState)); this.showNotification('<i class="fas fa-save"></i> Oyun kaydedildi!', 'info');
            }
            loadGame() {
                try {
                    const savedData = localStorage.getItem(CONFIG.SAVE_KEY);
                    if (savedData) {
                        const plainState = JSON.parse(savedData);
                        this.state = {
                            ...plainState,
                            gladiators: (plainState.gladiators || []).map(g => Gladiator.fromPlainObject(g)),
                            inventory: (plainState.inventory || []).map(i => Item.fromPlainObject(i)),
                            quests: Object.fromEntries(Object.entries(CONFIG.quests).map(([id, defaultQuest]) => { 
                                const savedQuest = plainState.quests?.[id]; 
                                return [id, { 
                                    ...defaultQuest, 
                                    ...(savedQuest || {}), 
                                    progress: savedQuest?.progress || 0 // Ensure progress exists and is 0 if not saved
                                }]; 
                            })),
                            lostGladiators: plainState.lostGladiators || 0, 
                            currentArena: plainState.currentArena || 'minor_arena_rome',
                            bankedGold: plainState.bankedGold || 0, 
                            accruedInterest: plainState.accruedInterest || 0, 
                            lastInterestCollectTime: plainState.lastInterestCollectTime || Date.now(),
                            marketStocks: plainState.marketStocks || {}
                        };
                        // Her zaman CONFIG'deki tüm eşyaların stoklarını kontrol et
                        for (const itemKey in CONFIG.items) {
                            this.state.marketStocks[itemKey] = this.state.marketStocks[itemKey] ?? CONFIG.items[itemKey].stock;
                        }
                        this.showNotification('<i class="fas fa-history"></i> Oyun yüklendi!', 'info');
                    } else { this.initializeNewGame(); this.showNotification('<i class="fas fa-scroll"></i> Yeni bir gladyatör okulu açtın!', 'info'); }
                } catch (e) { console.error("Kayıtlı oyun verisi bozuk, yeni oyun başlatılıyor:", e); this.initializeNewGame(); this.showNotification('<i class="fas fa-exclamation-triangle"></i> Kayıtlı oyun yüklenemedi veya bozuk, yeni bir oyun başlatıldı!', 'error'); }
            }
            initializeNewGame() {
                this.state = { 
                    ...CONFIG.initialResources, 
                    gladiators: [], 
                    inventory: [], 
                    nextGladiatorId: 1, 
                    nextItemId: 1, 
                    quests: JSON.parse(JSON.stringify(CONFIG.quests)), 
                    lostGladiators: 0, 
                    currentArena: 'minor_arena_rome', 
                    bankedGold: 0, 
                    accruedInterest: 0, 
                    lastInterestCollectTime: Date.now(), 
                    marketStocks: {} 
                };
                for (const itemKey in CONFIG.items) this.state.marketStocks[itemKey] = CONFIG.items[itemKey].stock;
                this.recruitGladiator('volunteer'); // Oyuna başlarken bir gladyatör ver
            }

            resetGameConfirmation() { this.showModal('<i class="fas fa-sync-alt"></i> Oyunu Sıfırla', '<p>Tüm ilerlemeni kaybetmek üzeresin! Bu işlem geri alınamaz. Emin misin?</p>', [{ text: 'Evet, Sıfırla', class: 'btn-primary', action: () => this.resetGame() }, { text: 'Hayır, İptal', action: () => {} }]); }
            resetGame() { localStorage.removeItem(CONFIG.SAVE_KEY); this.initializeNewGame(); this.updateUI(); this.showNotification('<i class="fas fa-sync-alt"></i> Oyun sıfırlandı! Yeni bir başlangıç...', 'info'); }

            updateUI() {
                // UI Güncelleme (daha kısa, daha okunabilir)
                if (this.dom.goldVal) this.dom.goldVal.textContent = this.state.gold;
                if (this.dom.gemsVal) this.dom.gemsVal.textContent = this.state.gems;
                if (this.dom.reputationVal) this.dom.reputationVal.textContent = this.state.reputation;

                if (this.dom.palaceTotalWins) this.dom.palaceTotalWins.textContent = this.state.wins;
                if (this.dom.palaceReputation) this.dom.palaceReputation.textContent = this.state.reputation;
                if (this.dom.palaceTotalGladiators) this.dom.palaceTotalGladiators.textContent = this.state.gladiators.length;
                if (this.dom.palaceLostGladiators) this.dom.palaceLostGladiators.textContent = this.state.lostGladiators;

                this.renderGladiatorGrid(); 
                this.renderMapGrid(); 
                this.renderArenaSelectors(); 
                this.renderTrainingPanel();
                this.renderBarracksPanel(); 
                this.renderMarket(); 
                this.renderBank(); 
                this.renderQuests(); 
                this.renderLegends();
                this.saveGame();
            }
            
            renderGladiatorGrid() {
                if (!this.dom.gladiatorGrid) { console.warn("gladiatorGrid DOM element not found."); return; }
                this.dom.gladiatorGrid.innerHTML = this.state.gladiators.length === 0 ? '<p style="grid-column: 1 / -1; text-align: center;">Henüz gladyatörün yok. Arenaya hükmetmek için birini topla!</p>' :
                    this.state.gladiators.map(glad => {
                        const xpRequired = glad.level * CONFIG.combat.LEVEL_UP_XP_MULTIPLIER;
                        const xpPercent = xpRequired > 0 ? (glad.xp / xpRequired) * 100 : 100;
                        const hpPercent = glad.getEffectiveStat('stamina') > 0 ? (glad.currentHp / glad.getEffectiveStat('stamina')) * 100 : 0;
                        const traitsHtml = glad.traits.length > 0 ? <div style="margin-top: 10px; font-size: 0.8em; color: var(--marble);"><strong>Özellikler:</strong> ${glad.traits.map(t => t.name).join(', ')}</div> : '';
                        
                        return `
                            <div class="gladiator-card" style="opacity:${glad.isAlive ? '1' : '0.6'}; border-color:${glad.isAlive ? 'var(--bronze)' : 'var(--roman-red)'}; cursor:${glad.isAlive ? 'pointer' : 'not-allowed'}" onclick="game.showGladiatorDetails('${glad.id}')">
                                <div class="gladiator-header">
                                    <span class="gladiator-name">${glad.name}</span>
                                    <span class="gladiator-type">${glad.type} ${glad.isAlive ? '(Yaşıyor)' : '(ÖLÜ)'}</span>
                                </div>
                                <div class="gladiator-stats">
                                    <div class="stat-item"><span class="stat-label">Güç</span><span class="stat-value">${glad.getEffectiveStat('strength')}</span></div>
                                    <div class="stat-item"><span class="stat-label">Savunma</span><span class="stat-value">${glad.getEffectiveStat('defense')}</span></div>
                                    <div class="stat-item"><span class="stat-label">Hız</span><span class="stat-value">${glad.getEffectiveStat('speed')}</span></div>
                                    <div class="stat-item"><span class="stat-label">Can</span><span class="stat-value">${glad.currentHp}/${glad.getEffectiveStat('stamina')}</span></div>
                                </div>
                                <div class="health-bar" style="margin-top: 15px;">
                                    <div class="health-fill" style="width: ${hpPercent}%; background-color: ${hpPercent > 50 ? 'var(--hp-green)' : (hpPercent > 20 ? 'orange' : 'var(--hp-red)')};">
                                        <span class="health-text">${glad.currentHp}/${glad.getEffectiveStat('stamina')} HP</span>
                                    </div>
                                </div>
                                <div class="progress-bar" title="XP: ${glad.xp} / ${xpRequired}" style="margin-top: 10px;">
                                    <div class="progress-fill" style="width: ${xpPercent}%;"></div>
                                </div>
                                <div style="font-size:0.8em; text-align:center;">Seviye: ${glad.level}</div>
                                ${traitsHtml}
                            </div>
                        `;
                    }).join('');
            }

            renderRecruitOptions() {
                if (!this.dom.recruitOptionsGrid) { console.warn("recruitOptionsGrid DOM element not found."); return; }
                const maxGladLevel = this.state.gladiators.length > 0 ? Math.max(...this.state.gladiators.map(g => g.level)) : 0;
                this.dom.recruitOptionsGrid.innerHTML = Object.keys(CONFIG.recruitmentOptions).map(key => {
                    const option = CONFIG.recruitmentOptions[key];
                    const canAfford = this.state.gold >= option.cost;
                    const meetsReputation = this.state.reputation >= (option.reputationRequired || 0);
                    const meetsLevel = maxGladLevel >= (option.levelRequired || 0);
                    const isDisabled = !(canAfford && meetsReputation && meetsLevel);

                    let reqs = [];
                    if (!canAfford) reqs.push(<i class="fas fa-coins"></i> Yetersiz Altın (${option.cost}));
                    if (!meetsReputation) reqs.push(<i class="fas fa-star"></i> İtibar ${option.reputationRequired} Gerekli);
                    if (!meetsLevel) reqs.push(<i class="fas fa-arrow-up"></i> Gladyatör Lvl ${option.levelRequired} Gerekli);
                    const requirementsHtml = reqs.length ? <div style="font-size:0.8em; color:var(--roman-red); margin-top:10px; line-height:1.2;"><strong>Gereksinimler:</strong><br>${reqs.join('<br>')}</div> : '';

                    return `
                        <div class="recruit-option-card ${isDisabled ? 'disabled' : ''}" ${isDisabled ? '' : onclick="game.recruitGladiator('${key}');"}>
                            <div class="option-icon"><i class="fas ${option.icon}"></i></div>
                            <div class="option-name">${option.name}</div>
                            <div class="option-desc">${option.desc}</div>
                            <div class="option-stats">Başlangıç Statları: G:${option.baseStats.str.join('-')}, S:${option.baseStats.def.join('-')}, H:${option.baseStats.spd.join('-')}, C:${option.baseStats.sta.join('-')}
                            <br>XP Kazanım: x${option.xpGainMultiplier} | Beceri Şansı: %${(option.traitChance * 100).toFixed(0)}</div>
                            <div class="option-cost" style="margin-top: 15px;"><i class="fas fa-coins"></i> ${option.cost} Altın</div>
                            ${requirementsHtml}
                        </div>
                    `;
                }).join('');
            }

            renderMapGrid() {
                if (!this.dom.mapGrid) { console.warn("mapGrid DOM element not found."); return; }
                this.dom.mapGrid.innerHTML = Object.keys(CONFIG.locations).map(locKey => {
                    const loc = CONFIG.locations[locKey];
                    const isLocLocked = this.state.reputation < (loc.reputationRequired || 0);
                    const maxGladLevel = this.state.gladiators.length > 0 ? Math.max(...this.state.gladiators.map(g => g.level)) : 0;

                    const arenasHtml = Object.keys(loc.arenas).map(arenaKey => {
                        const arena = loc.arenas[arenaKey];
                        const isArenaLockedByLevel = maxGladLevel < arena.levelRequired;
                        const isTotallyLocked = isArenaLockedByLevel || isLocLocked;

                        return `
                            <li class="${isTotallyLocked ? 'locked' : ''}">
                                <strong>${arena.name}</strong> 
                                <span>(Min. Lvl: ${arena.levelRequired}, Tip: ${arena.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())})</span>
                                ${isTotallyLocked ? <i class="fas fa-lock" title="Gereken: Min. Gladyatör Lvl ${arena.levelRequired}${isLocLocked ? ', Şehir İtibar ' + loc.reputationRequired : ''}"></i> : ''}
                                <button class="btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="game.selectArena('${locKey}', '${arenaKey}')" ${isTotallyLocked ? 'disabled' : ''}>Seç</button>
                            </li>
                        `;
                    }).join('');

                    return `
                        <div class="location-card ${isLocLocked ? 'locked' : ''}">
                            <div class="location-title"><i class="fas ${loc.icon}"></i> ${loc.name}</div>
                            <div class="location-desc">${loc.description}</div>
                            ${isLocLocked ? <p style="font-size: 0.9em; color: var(--roman-red); margin-top: 10px;"><i class="fas fa-lock"></i> İtibar ${loc.reputationRequired} Gerekli</p> : ''}
                            <h4 style="color: var(--gold); margin-top: 15px; margin-bottom: 10px;">Arenalalar:</h4>
                            <ul class="arena-list">${arenasHtml}</ul>
                        </div>
                    `;
                }).join('');
            }

            selectArena(locationKey, arenaKey) {
                const loc = CONFIG.locations[locationKey]; 
                const arena = loc.arenas[arenaKey];
                const maxGladLevel = this.state.gladiators.length > 0 ? Math.max(...this.state.gladiators.map(g => g.level)) : 0;

                if (this.state.reputation < (loc.reputationRequired || 0)) {
                    this.showNotification(<i class="fas fa-lock"></i> Bu şehre girmek için itibar ${loc.reputationRequired} olmalı., 'error'); return;
                }
                if (maxGladLevel < arena.levelRequired) {
                    this.showNotification(<i class="fas fa-lock"></i> Bu arenaya girmek için gladyatörlerinden birinin seviyesi ${arena.levelRequired} olmalı., 'error'); return;
                }
                this.state.currentArena = arenaKey;
                this.showNotification(<i class="fas fa-check"></i> Arena ${arena.name} (${loc.name}) olarak seçildi!, 'info');
                if (this.dom.navMenu) {
                    this.dom.navMenu.querySelector('.nav-button.active')?.classList.remove('active');
                    this.dom.navMenu.querySelector('[data-section="arena"]')?.classList.add('active');
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    document.getElementById('arena')?.classList.add('active');
                }
                this.updateArenaStats();
            }

            renderArenaSelectors() {
                if (!this.dom.playerSelect || !this.dom.opponentSelect || !this.dom.currentArenaName || !this.dom.currentArenaRewards || !this.dom.currentArenaAudience || !this.dom.currentArenaType || !this.dom.startBattleBtn) {
                     console.warn("Arena selector DOM elements not found."); return;
                }

                const arena = this.getCurrentArena();
                if (arena) {
                    this.dom.currentArenaName.textContent = arena.name;
                    this.dom.currentArenaRewards.innerHTML = ${arena.reward.gold} <i class="fas fa-coins"></i>, ${arena.reward.rep} <i class="fas fa-star"></i>, ${arena.reward.xp} XP;
                    this.dom.currentArenaAudience.textContent = arena.audience;
                    this.dom.currentArenaType.textContent = arena.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                } else {
                    this.dom.currentArenaName.textContent = 'Seçiniz';
                    this.dom.currentArenaRewards.innerHTML = 'N/A';
                    this.dom.currentArenaAudience.textContent = 'N/A';
                    this.dom.currentArenaType.textContent = 'N/A';
                }

                this.dom.playerSelect.innerHTML = <option value="">Gladyatör Seç</option> + this.state.gladiators.filter(g => g.isAlive).map(g => <option value="${g.id}">${g.name} (Lvl ${g.level} - ${g.currentHp}/${g.getEffectiveStat('stamina')} HP)</option>).join('');
                
                if (arena?.opponents?.length) {
                    if (arena.type !== 'regular') { // Famous Gladiator Challenge, Animal Fight, Group Combat, Tournament
                        // Bu tür arenalarda rakip seçimi yapılmaz, otomatik belirlenir veya zorunlu olarak seçilir
                        // İlk rakibi göster veya özel bir metin belirle
                        const firstOpponentConfig = CONFIG.opponents[arena.opponents[0]];
                        this.dom.opponentSelect.innerHTML = <option value="${arena.opponents[0]}">${firstOpponentConfig?.name || 'Rakip'}</option>;
                        this.dom.opponentSelect.disabled = true; // Seçim yapılamaz
                        if (arena.type === 'group_combat') {
                            this.dom.opponentSelect.innerHTML = <option value="">Birden Fazla Rakip</option>;
                        } else if (arena.type === 'famous_gladiator_challenge') {
                             this.dom.opponentSelect.innerHTML = <option value="${arena.opponents[0]}">${firstOpponentConfig?.name || 'Rakip'}</option>;
                        } else if (arena.type === 'animal_fight') {
                            this.dom.opponentSelect.innerHTML = <option value="">Hayvanlar</option>;
                        } else { // Tournament
                            this.dom.opponentSelect.innerHTML = <option value="">Turnuva Rakipleri</option>;
                        }
                    } else { // Regular arena, rakip seçimi serbest
                        this.dom.opponentSelect.innerHTML = <option value="">Rakip Seç</option> + arena.opponents.map(k => <option value="${k}">${CONFIG.opponents[k]?.name || k}</option>).join('');
                        this.dom.opponentSelect.disabled = false; // Seçim yapılabilir
                    }
                } else {
                    this.dom.opponentSelect.innerHTML = <option value="">Rakip Seçilemiyor</option>;
                    this.dom.opponentSelect.disabled = true;
                }
                this.updateArenaStats();
            }
            
            renderTrainingPanel() {
                if (!this.dom.trainingSelect || !this.dom.trainingGrid) { console.warn("Training DOM elements not found."); return; }
                
                const currentGladId = parseInt(this.dom.trainingSelect.value);
                // Canlı gladyatörleri listele
                const aliveGladiators = this.state.gladiators.filter(g => g.isAlive);
                this.dom.trainingSelect.innerHTML = <option value="">Gladyatör Seç</option> + aliveGladiators.map(g => <option value="${g.id}" ${currentGladId === g.id ? 'selected' : ''}>${g.name} (Lvl ${g.level})</option>).join('');
                
                const selectedGlad = aliveGladiators.find(g => g.id === currentGladId);
                
                this.dom.trainingGrid.innerHTML = Object.keys(CONFIG.training).map(key => {
                    const train = CONFIG.training[key];
                    const isTraitLearnDisabled = (key === 'trait_learn' && selectedGlad && selectedGlad.traits.length >= CONFIG.gladiatorTraits.length);
                    const isDisabled = !selectedGlad || this.state.gold < train.cost || isTraitLearnDisabled;

                    return `
                        <div class="training-option ${isDisabled ? 'disabled' : ''}" ${isDisabled ? '' : onclick="game.handleTrain('${key}')"}>
                            <div><div class="training-icon"><i class="fas ${train.icon}"></i></div>
                                <div class="training-name">${train.name}</div>
                                <div style="margin-top: 10px; font-size: 0.9em; color: var(--marble);">${train.desc}</div>
                            </div>
                            <div class="training-cost" style="margin-top: 15px;"><i class="fas fa-coins"></i> ${train.cost} Altın</div>
                        </div>
                    `;
                }).join('');
                // Sadece DOM'a eklendikten sonra event listener ekle
                if (this.dom.trainingSelect) {
                    this.dom.trainingSelect.onchange = () => this.renderTrainingPanel();
                }
            }

            renderBarracksPanel() {
                if (!this.dom.barracksSelect || !this.dom.restOption || !this.dom.healerOption || !this.dom.healerCost) { console.warn("Barracks DOM elements not found."); return; }
                
                const currentGladId = parseInt(this.dom.barracksSelect.value);
                this.dom.barracksSelect.innerHTML = <option value="">Gladyatör Seç</option> + this.state.gladiators.map(g => <option value="${g.id}" ${currentGladId === g.id ? 'selected' : ''}>${g.name} (${g.currentHp}/${g.getEffectiveStat('stamina')} HP) ${g.isAlive ? '' : '(Ölü)'}</option>).join('');
                
                const selectedGlad = this.state.gladiators.find(g => g.id === currentGladId);
                const healerCost = selectedGlad ? Math.ceil(CONFIG.healingOptions.healer.baseCost * (1 + (selectedGlad.level * 0.1))) : CONFIG.healingOptions.healer.baseCost; 
                this.dom.healerCost.textContent = healerCost;

                const canRest = selectedGlad?.canBeHealedByRest();
                const canHealByHealer = selectedGlad?.canBeHealedByHealer() && this.state.gold >= healerCost;

                this.dom.restOption.classList.toggle('disabled', !canRest); 
                this.dom.restOption.onclick = canRest ? () => this.handleHealing('rest') : null;
                
                this.dom.healerOption.classList.toggle('disabled', !canHealByHealer); 
                this.dom.healerOption.onclick = canHealByHealer ? () => this.handleHealing('healer') : null;
                
                if (this.dom.barracksSelect) {
                    this.dom.barracksSelect.onchange = () => this.renderBarracksPanel();
                }
            }
            
            renderMarket() {
                if (!this.dom.marketCategories || !this.dom.marketGrid) { console.warn("Market DOM elements not found."); return; }
                const categories = ['all', 'weapon', 'armor', 'helmet', 'consumable'];
                this.dom.marketCategories.innerHTML = categories.map(cat => <button class="btn ${this.currentMarketCategory === cat ? 'active' : ''}" onclick="game.currentMarketCategory = '${cat}'; game.renderMarket();">${cat.charAt(0).toUpperCase() + cat.slice(1)}</button>).join('');

                this.dom.marketGrid.innerHTML = Object.keys(CONFIG.items).map(itemKey => {
                    const itemConfig = CONFIG.items[itemKey];
                    if (this.currentMarketCategory !== 'all' && itemConfig.type !== this.currentMarketCategory) return '';
                    if (this.state.marketStocks[itemKey] <= 0) return ''; // Stok 0 ise gösterme

                    const tempItem = Item.fromPlainObject({ ...itemConfig, level: 0 }); // Stok bilgisi buraya atanmaz, sadece gösterim için configden gelir.
                    const bonusString = tempItem.getBonusString();
                    const canAfford = this.state.gold >= itemConfig.cost;
                    const isDisabled = !canAfford || this.state.marketStocks[itemKey] <= 0;

                    return `
                        <div class="market-item">
                            <div class="item-icon" style="font-size: 3em; margin-bottom: 10px;"><i class="fas ${itemConfig.icon}"></i></div>
                            <div class="item-name">${itemConfig.name}</div>
                            <div class="item-rarity rarity-${itemConfig.rarity}">${itemConfig.rarity.charAt(0).toUpperCase() + itemConfig.rarity.slice(1)}</div>
                            <div style="font-size: 0.8em; color: var(--marble); margin-bottom: 5px;">${itemConfig.type.charAt(0).toUpperCase() + itemConfig.type.slice(1)} ${bonusString}</div>
                            <div class="item-price"><i class="fas fa-coins"></i> ${itemConfig.cost} <span style="margin-left: 10px;">Stok: ${this.state.marketStocks[itemKey]}</span></div>
                            <button class="btn" style="font-size: 0.8em; padding: 8px 16px;" ${isDisabled ? 'disabled' : onclick="game.buyMarketItem('${itemKey}')"}>${isDisabled ? 'Yetersiz Altın' : 'Satın Al'}</button>
                        </div>
                    `;
                }).join('');
            }

            renderBank() {
                if (!this.dom.bankGold || !this.dom.bankInterestRate || !this.dom.bankAccruedInterest || !this.dom.bankAmountInput || !this.dom.bankDepositBtn || !this.dom.bankWithdrawBtn || !this.dom.bankCollectInterestBtn) {
                    console.warn("Bank DOM elements not found."); return;
                }
                this.dom.bankGold.textContent = this.state.bankedGold;
                this.dom.bankInterestRate.textContent = ${(CONFIG.bank.interestRate * 100).toFixed(0)}% (per battle win); 
                this.dom.bankAccruedInterest.textContent = this.state.accruedInterest.toFixed(0);

                const amount = parseInt(this.dom.bankAmountInput.value) || 0;
                this.dom.bankDepositBtn.disabled = (amount <= 0 || this.state.gold < amount);
                this.dom.bankWithdrawBtn.disabled = (amount <= 0 || this.state.bankedGold < amount);
                this.dom.bankCollectInterestBtn.disabled = (this.state.accruedInterest <= 0);
            }

            bankDeposit() {
                const amount = parseInt(this.dom.bankAmountInput.value);
                if (isNaN(amount) || amount <= 0 || this.state.gold < amount) { this.showNotification('<i class="fas fa-exclamation-triangle"></i> Geçersiz veya yetersiz altın miktarı!', 'error'); return; }
                this.state.gold -= amount; this.state.bankedGold += amount;
                this.showNotification(<i class="fas fa-money-bill-transfer"></i> ${amount} altın bankaya yatırıldı., 'success');
                this.checkQuestProgress('bank_total_deposit', { amount: this.state.bankedGold }); this.updateUI();
            }
            bankWithdraw() {
                const amount = parseInt(this.dom.bankAmountInput.value);
                if (isNaN(amount) || amount <= 0 || this.state.bankedGold < amount) { this.showNotification('<i class="fas fa-exclamation-triangle"></i> Geçersiz veya bankada yeterli altın miktarı yok!', 'error'); return; }
                this.state.gold += amount; this.state.bankedGold -= amount;
                this.showNotification(<i class="fas fa-money-bill-transfer"></i> ${amount} altın bankadan çekildi., 'info'); this.updateUI();
            }
            collectInterest() {
                if (this.state.accruedInterest <= 0) { this.showNotification('<i class="fas fa-info-circle"></i> Henüz birikmiş faiz yok!', 'info'); return; }
                this.state.gold += Math.floor(this.state.accruedInterest); // Küsuratları at
                this.showNotification(<i class="fas fa-sack-dollar"></i> ${Math.floor(this.state.accruedInterest).toFixed(0)} altın faiz toplandı!, 'success');
                this.state.accruedInterest = 0; this.updateUI();
            }
            calculateAndAccrueInterest() {
                // Her savaş zaferinde veya zaman geçişinde faiz biriktir
                const interestEarned = Math.min(this.state.bankedGold * CONFIG.bank.interestRate, CONFIG.bank.maxInterestPerCollection);
                this.state.accruedInterest += interestEarned;
            }

            renderQuests() {
                if (!this.dom.questList || !this.dom.noQuestsMessage) { console.warn("Quest DOM elements not found."); return; }
                const questsToShow = Object.values(this.state.quests).filter(q => q.status !== 'completed' && this.state.reputation >= (q.reputationRequired || 0));
                this.dom.noQuestsMessage.style.display = questsToShow.length ? 'none' : 'block';

                this.dom.questList.innerHTML = questsToShow.map(q => {
                    let rewards = [];
                    if (q.rewards.gold) rewards.push(${q.rewards.gold} <i class="fas fa-coins"></i>);
                    if (q.rewards.rep) rewards.push(${q.rewards.rep} <i class="fas fa-star"></i>);
                    if (q.rewards.xp_bonus) rewards.push(${q.rewards.xp_bonus} XP bonusu);
                    if (q.rewards.gems) rewards.push(${q.rewards.gems} <i class="fas fa-gem"></i>);

                    let progressText = '';
                    if (['train_stat', 'item_upgrade_level'].includes(q.target.type)) {
                        progressText = İlerleme: ${q.progress || 0}/${q.target.amount};
                    } else if (q.target.type === 'bank_total_deposit') {
                        progressText = İlerleme: ${Math.min(q.progress || 0, q.target.amount)}/${q.target.amount}; // Mevcut yatırılan miktar
                    }

                    return `
                        <li class="quest-item ${q.status} ${q.status === 'completed' ? 'completed' : ''}">
                            <div class="quest-title"><i class="fas fa-scroll"></i> ${q.name}</div>
                            <div class="quest-description">${q.description}</div>
                            <div class="quest-rewards"><i class="fas fa-gift"></i> Ödüller: ${rewards.join(', ')}</div>
                            <div class="quest-buttons">
                                ${q.status === 'active' ? <span style="color: var(--marble); margin-right: 10px;">Görev Aktif! ${progressText}</span> : <button class="btn btn-primary" onclick="game.acceptQuest('${q.id}')">Kabul Et</button>}
                            </div>
                        </li>
                    `;
                }).join('');
            }

            renderLegends() {
                if (!this.dom.legendsGrid) { console.warn("LegendsGrid DOM element not found."); return; }
                const maxGladLevel = this.state.gladiators.length > 0 ? Math.max(...this.state.gladiators.map(g => g.level)) : 0;
                this.dom.legendsGrid.innerHTML = Object.keys(CONFIG.famousGladiators).map(key => {
                    const legend = CONFIG.famousGladiators[key];
                    const meetsRep = this.state.reputation >= (legend.repRequired || 0);
                    const meetsLevel = maxGladLevel >= (legend.levelRequired || 0);
                    const canAffordGold = this.state.gold >= (legend.cost.gold || 0);
                    const canAffordGems = this.state.gems >= (legend.cost.gems || 0);
                    const isDisabled = !(meetsRep && meetsLevel && canAffordGold && canAffordGems);

                    let reqs = [];
                    if (!canAffordGold) reqs.push(<i class="fas fa-coins"></i> Yetersiz Altın (${legend.cost.gold}));
                    if (!canAffordGems) reqs.push(<i class="fas fa-gem"></i> Yetersiz Mücevher (${legend.cost.gems}));
                    if (!meetsRep) reqs.push(<i class="fas fa-star"></i> İtibar ${legend.repRequired} Gerekli);
                    if (!meetsLevel) reqs.push(<i class="fas fa-arrow-up"></i> Gladyatör Lvl ${legend.levelRequired} Gerekli);
                    const requirementsHtml = reqs.length ? <div style="font-size:0.8em; color:var(--roman-red); margin-top:10px; line-height:1.2;"><strong>Gereksinimler:</strong><br>${reqs.join('<br>')}</div> : '';
                    
                    const traitsList = legend.traits.map(tId => CONFIG.gladiatorTraits.find(t => t.id === tId)?.name || tId).join(', ');

                    return `
                        <div class="legend-card ${isDisabled ? 'disabled' : ''}">
                            <div class="legend-icon"><i class="fas ${legend.icon}"></i></div>
                            <div class="legend-name">${legend.name}</div>
                            <div class="legend-desc">${legend.description}</div>
                            <div class="legend-stats">Statlar: G:${legend.stats.str}, S:${legend.stats.def}, H:${legend.stats.spd}, C:${legend.stats.sta}</div>
                            <div class="legend-traits">Özellikler: ${traitsList}</div>
                            <div class="legend-cost" style="margin-top: 15px;"><i class="fas fa-coins"></i> ${legend.cost.gold} <i class="fas fa-gem"></i> ${legend.cost.gems}</div>
                            ${requirementsHtml}
                            <button class="btn btn-primary" style="margin-top: 15px;" ${isDisabled ? 'disabled' : onclick="game.recruitLegendaryGladiator('${key}')"}>İşe Al</button>
                        </div>
                    `;
                }).join('');
            }
            
            recruitLegendaryGladiator(legendKey) {
                const legend = CONFIG.famousGladiators[legendKey]; 
                const maxGladLevel = this.state.gladiators.length > 0 ? Math.max(...this.state.gladiators.map(g => g.level)) : 0;
                
                if (!(this.state.reputation >= (legend.repRequired || 0) && maxGladLevel >= (legend.levelRequired || 0) && this.state.gold >= (legend.cost.gold || 0) && this.state.gems >= (legend.cost.gems || 0))) { 
                    this.showNotification('<i class="fas fa-exclamation-triangle"></i> Bu efsaneyi işe almak için yeterli gereksinimleri karşılamıyorsun!', 'error'); return; 
                }
                
                this.showModal('Efsanevi Gladyatör İşe Al', <strong>${legend.name}</strong> adlı efsanevi gladyatörü kadrona katmak üzeresin. <br><br> Bu işlem <strong>${legend.cost.gold} altın ve ${legend.cost.gems} mücevhere</strong> mal olacak. Onaylıyor musun?,
                    [{ text: 'Onayla', class: 'btn-primary', action: () => { 
                        this.state.gold -= legend.cost.gold; 
                        this.state.gems -= legend.cost.gems;
                        this.state.gladiators.push(new Gladiator(this.state.nextGladiatorId++, legend.name, legend.type, legend.stats.str, legend.stats.def, legend.stats.spd, legend.stats.sta, null, legend.levelRequired || 1, 0, true, {}, legend.traits));
                        this.showNotification(<i class="fas fa-medal"></i> <strong>${legend.name}</strong> kadrona katıldı!, 'success'); 
                        this.updateUI(); 
                    }
                    }, { text: 'İptal', action: () => {} }]);
            }

            recruitGladiator(typeKey) {
                const option = CONFIG.recruitmentOptions[typeKey]; 
                const maxGladLevel = this.state.gladiators.length > 0 ? Math.max(...this.state.gladiators.map(g => g.level)) : 0;
                
                if (!(this.state.gold >= option.cost && this.state.reputation >= (option.reputationRequired || 0) && maxGladLevel >= (option.levelRequired || 0))) { 
                    this.showNotification('<i class="fas fa-exclamation-triangle"></i> Yetersiz kaynak veya gereksinimleri karşılamıyorsun!', 'error'); return; 
                }
                
                this.state.gold -= option.cost;
                const newGlad = new Gladiator(
                    this.state.nextGladiatorId++, 
                    this.getRandomItem(CONFIG.gladiatorNames), 
                    this.getRandomItem(CONFIG.gladiatorTypes), 
                    this.getRandom(...option.baseStats.str), 
                    this.getRandom(...option.baseStats.def), 
                    this.getRandom(...option.baseStats.spd), 
                    this.getRandom(...option.baseStats.sta)
                );
                
                if (Math.random() < option.traitChance && CONFIG.gladiatorTraits.length > 0) {
                    const availableTraits = CONFIG.gladiatorTraits.filter(t => !newGlad.hasTrait(t.id));
                    if (availableTraits.length > 0) {
                         newGlad.addTrait(this.getRandomItem(availableTraits).id);
                    }
                }
                
                this.state.gladiators.push(newGlad); 
                this.showNotification(<i class="fas fa-user-plus"></i> <strong>${newGlad.name}</strong> adında yeni bir ${option.name.toLowerCase()} kadrona katıldı!, 'success');
                this.checkQuestProgress('recruit_type', { gladiatorType: typeKey }); 
                this.updateUI();
                this.hideRecruitModal(); // İşe alındıktan sonra modalı kapat
            }

            sellGladiator(gladId) {
                const gladIdx = this.state.gladiators.findIndex(g => g.id === gladId); 
                if (gladIdx === -1) { this.showNotification('<i class="fas fa-info-circle"></i> Gladyatör bulunamadı!', 'error'); return; }
                const glad = this.state.gladiators[gladIdx];
                
                // Gladyatörün temel işe alım maliyetini al (eğer varsa)
                const baseRecruitCost = CONFIG.recruitmentOptions[glad.type.toLowerCase()]?.cost || 0;
                let sellPrice = Math.round(
                    (CONFIG.gladiatorSellValueMultiplier.base * baseRecruitCost) + 
                    (glad.level * CONFIG.gladiatorSellValueMultiplier.perLevel) + 
                    (glad.wins * CONFIG.gladiatorSellValueMultiplier.perWin) + 
                    (glad.traits.length * CONFIG.gladiatorSellValueMultiplier.perTrait)
                );
                
                if (!glad.isAlive) { // Ölü gladyatörler daha az değerlidir
                    sellPrice = Math.round(sellPrice * 0.25);
                }
                sellPrice = Math.max(0, sellPrice); // Negatif olamaz

                this.showModal('Gladyatör Sat', <strong>${glad.name}</strong> adlı gladyatörü <strong>${sellPrice} altına</strong> satmak üzeresin. Onaylıyor musun?,
                    [{ text: 'Sat', class: 'btn-primary', action: () => {
                        // Kuşanılmış eşyaları envantere geri ekle
                        Object.values(glad.equippedItems).forEach(item => { 
                            if (item) { 
                                glad.unequipItem(item.type); 
                                this.state.inventory.push(item); 
                            } 
                        });
                        this.state.gladiators.splice(gladIdx, 1); 
                        this.state.gold += sellPrice;
                        this.showNotification(<i class="fas fa-hand-holding-usd"></i> <strong>${glad.name}</strong> başarıyla satıldı! (${sellPrice} altın), 'success');
                        this.updateUI(); 
                        this.hideModal(); 
                    }
                    }, { text: 'İptal', action: () => {} }]);
            }

            handleTrain(statKey) {
                const glad = this.state.gladiators.find(g => g.id === parseInt(this.dom.trainingSelect.value)); 
                const trainInfo = CONFIG.training[statKey];
                
                if (!glad || !glad.isAlive) { 
                    this.showNotification('<i class="fas fa-info-circle"></i> Lütfen canlı bir gladyatör seçin!', 'error'); return; 
                }
                if (this.state.gold < trainInfo.cost) {
                    this.showNotification('<i class="fas fa-exclamation-triangle"></i> Yeterli altının yok!', 'error'); return;
                }
                if (statKey === 'trait_learn' && glad.traits.length >= CONFIG.gladiatorTraits.length) {
                    this.showNotification('<i class="fas fa-info-circle"></i> <strong>${glad.name}</strong> zaten tüm becerileri biliyor!', 'info'); return;
                }

                this.showModal('Antrenman Onayı', <strong>${glad.name}</strong> adlı gladyatörün <strong>${trainInfo.name}</strong> ile eğitilecek. <br><br> Bu işlem <strong>${trainInfo.cost} altına</strong> mal olacak. Onaylıyor musun?,
                    [{ text: 'Eğit', class: 'btn-primary', action: () => this.processTraining(glad, statKey, trainInfo) }, { text: 'İptal', action: () => {} }]);
            }
            processTraining(glad, statKey, trainInfo) {
                if (this.state.gold < trainInfo.cost) { this.showNotification('<i class="fas fa-exclamation-triangle"></i> Yeterli altının yok!', 'error'); return; }
                this.state.gold -= trainInfo.cost;
                if (Math.random() < trainInfo.successChance) {
                    if (statKey === 'trait_learn') { 
                        const availTraits = CONFIG.gladiatorTraits.filter(t => !glad.hasTrait(t.id)); 
                        if (availTraits.length > 0) { 
                            const newTrait = this.getRandomItem(availTraits);
                            glad.addTrait(newTrait.id); 
                            this.showNotification(<i class="fas fa-award"></i> <strong>${glad.name}</strong> yeni bir beceri öğrendi: <strong>${newTrait.name}</strong>!, 'success'); 
                            this.checkQuestProgress('learn_trait'); 
                        } else {
                            this.showNotification('<i class="fas fa-info-circle"></i> <strong>${glad.name}</strong> zaten tüm becerileri biliyor!', 'info');
                        }
                    } else { 
                        glad[statKey] += trainInfo.increase; 
                        this.showNotification(<i class="fas fa-check-circle"></i> <strong>${glad.name}</strong>'nin ${trainInfo.name} tamamlandı!, 'success'); 
                        this.checkQuestProgress('train_stat', { stat: statKey, amount: trainInfo.increase }); // Quest için stat ve miktar gönder
                    }
                } else this.showNotification(<i class="fas fa-times-circle"></i> <strong>${glad.name}</strong>'nin ${trainInfo.name} başarısız oldu!, 'error');
                this.updateUI();
            }

            handleHealing(optionKey) {
                const glad = this.state.gladiators.find(g => g.id === parseInt(this.dom.barracksSelect.value)); 
                const healingInfo = CONFIG.healingOptions[optionKey];
                
                if (!glad) { 
                    this.showNotification('<i class="fas fa-info-circle"></i> Lütfen bir gladyatör seçin!', 'error'); return; 
                }
                if (optionKey === 'rest' && !glad.canBeHealedByRest()) {
                    this.showNotification(<i class="fas fa-info-circle"></i> <strong>${glad.name}</strong>'nin dinlenmeye ihtiyacı yok veya ölü!, 'info'); return;
                }
                if (optionKey === 'healer' && !glad.canBeHealedByHealer()) {
                    this.showNotification(<i class="fas fa-info-circle"></i> <strong>${glad.name}</strong>'nin iyileşmeye ihtiyacı yok!, 'info'); return;
                }

                let cost = healingInfo.cost; 
                if (optionKey === 'healer') cost = Math.ceil(healingInfo.baseCost * (1 + (glad.level * 0.1)));
                
                if (this.state.gold < cost) { this.showNotification('<i class="fas fa-exclamation-triangle"></i> Yeterli altının yok!', 'error'); return; }
                
                this.showModal('İyileşme Onayı', <strong>${glad.name}</strong> adlı gladyatör ${healingInfo.name} ile iyileştirilecek. <br><br> Bu işlem <strong>${cost} altına</strong> mal olacak. Onaylıyor musun?,
                    [{ text: 'Onayla', class: 'btn-primary', action: () => { 
                        this.state.gold -= cost; 
                        glad.heal(Math.ceil(glad.getEffectiveStat('stamina') * healingInfo.healPercent)); 
                        this.showNotification(<i class="fas fa-heart"></i> <strong>${glad.name}</strong> ${healingInfo.name.toLowerCase()} sonrasında iyileşti!, 'success'); 
                        this.updateUI(); 
                    } }, { text: 'İptal', action: () => {} }]);
            }
            buyMarketItem(itemKey) {
                const itemConfig = CONFIG.items[itemKey];
                if (this.state.marketStocks[itemKey] <= 0) { this.showNotification('<i class="fas fa-exclamation-triangle"></i> Bu ürünün stoğu kalmadı!', 'error'); return; }
                if (this.state.gold < itemConfig.cost) { this.showNotification('<i class="fas fa-exclamation-triangle"></i> Yeterli altının yok!', 'error'); return; }
                
                this.showModal('Eşya Satın Al', <strong>${itemConfig.name}</strong> (${itemConfig.cost} <i class="fas fa-coins"></i>) satın almak üzeresin. Onaylıyor musun?,
                    [{ text: 'Satın Al', class: 'btn-primary', action: () => {
                        this.state.gold -= itemConfig.cost; 
                        this.state.marketStocks[itemKey]--;
                        this.state.inventory.push(Item.fromPlainObject({ ...itemConfig, id: generateUUID(), level: 0 })); // Yeni eşya, 0 seviyeden başlar
                        this.showNotification(<i class="fas fa-box-open"></i> <strong>${itemConfig.name}</strong> satın alındı ve envanterine eklendi!, 'success');
                        this.checkQuestProgress('buy_item_type', { itemType: itemConfig.type }); 
                        this.checkQuestProgress('buy_item_rarity', { rarity: itemConfig.rarity }); 
                        this.updateUI();
                    } }, { text: 'İptal', action: () => {} }]);
            }
            upgradeItem(gladId, itemId) {
                const glad = this.state.gladiators.find(g => g.id === gladId); 
                const item = Object.values(glad.equippedItems).find(i => i?.id === itemId); // Sadece kuşanılmış eşyalar yükseltilebilir

                if (!item) { this.showNotification('<i class="fas fa-info-circle"></i> Eşya bulunamadı!', 'info'); return; }
                if (item.maxLevel === 0) { this.showNotification('<i class="fas fa-info-circle"></i> Bu eşya yükseltilemez!', 'info'); return; }
                if (item.level >= item.maxLevel) { this.showNotification('<i class="fas fa-info-circle"></i> Eşya zaten maksimum seviyede!', 'info'); return; }
                
                const upgradeGoldCost = Math.round(item.upgradeCost.gold * (1 + item.level * 0.5)); 
                const upgradeGemCost = item.upgradeCost.gems;
                
                if (this.state.gold < upgradeGoldCost) { this.showNotification(<i class="fas fa-exclamation-triangle"></i> Yeterli altın (${upgradeGoldCost}) yok!, 'error'); return; }
                if (this.state.gems < upgradeGemCost) { this.showNotification(<i class="fas fa-exclamation-triangle"></i> Yeterli mücevher (${upgradeGemCost}) yok!, 'error'); return; }
                
                this.showModal('Eşya Yükselt', <strong>${item.name}</strong> (Lvl ${item.level}) eşyasını yükseltmek üzeresin. <br><br> Bu işlem <strong>${upgradeGoldCost} altın ve ${upgradeGemCost} mücevhere</strong> mal olacak. Onaylıyor musun?,
                    [{ text: 'Yükselt', class: 'btn-primary', action: () => {
                        this.state.gold -= upgradeGoldCost; 
                        this.state.gems -= upgradeGemCost; 
                        item.level++;
                        // Eşyanın bonuslarını güncelleyin, item.getEffectiveStat zaten bunu halledecek
                        // Eğer item.bonus objesini değiştirmek istiyorsanız:
                        // for (const stat in item.bonus) if (typeof item.bonus[stat] === 'number') item.bonus[stat] = item.bonus[stat] * 1.1; // Örneğin her seviyede bonus %10 artar
                        // if (item.healAmount) item.healAmount += Math.ceil(item.healAmount * 0.1); // İksir ise iyileştirme miktarı artar

                        this.showNotification(<i class="fas fa-hammer"></i> <strong>${item.name}</strong> ${item.level}. seviyeye yükseltildi!, 'success');
                        this.checkQuestProgress('item_upgrade_level', { level: item.level, itemId: item.id }); 
                        this.updateUI(); 
                        this.showGladiatorDetails(gladId, false); // Modalı açık tut ve yenile
                    } }, { text: 'İptal', action: () => {} }]);
            }

            sellItem(itemId) {
                const itemIdx = this.state.inventory.findIndex(i => i.id === itemId); 
                if (itemIdx === -1) { this.showNotification('<i class="fas fa-info-circle"></i> Eşya envanterinde bulunmuyor!', 'error'); return; }
                const item = this.state.inventory[itemIdx]; 
                // Eşyanın herhangi bir gladyatör tarafından kuşanılıp kuşanılmadığını kontrol et
                if (this.state.gladiators.some(g => Object.values(g.equippedItems).some(e => e?.id === item.id))) { 
                    this.showNotification(<i class="fas fa-ban"></i> <strong>${item.name}</strong> kuşanıldığı için satılamaz!, 'error'); return; 
                }
                this.showModal('Eşya Sat', <strong>${item.name}</strong> adlı eşyayı <strong>${item.sellValue} altına</strong> satmak üzeresin. Onaylıyor musun?,
                    [{ text: 'Sat', class: 'btn-primary', action: () => { 
                        this.state.inventory.splice(itemIdx, 1); 
                        this.state.gold += item.sellValue;
                        this.showNotification(<i class="fas fa-hand-holding-usd"></i> <strong>${item.name}</strong> başarıyla satıldı!, 'success'); 
                        this.updateUI();
                        // Gladyatör detay modalını yenilemek için
                        if (this.selectedGladiatorIdForModal) this.showGladiatorDetails(this.selectedGladiatorIdForModal, false); 
                        else this.hideModal(); 
                    }
                    }, { text: 'İptal', action: () => {} }]);
            }
            equipItem(gladId, itemId) {
                const glad = this.state.gladiators.find(g => g.id === gladId); 
                const itemIdx = this.state.inventory.findIndex(i => i.id === itemId);
                const itemToEquip = this.state.inventory[itemIdx];
                
                if (!glad || itemIdx === -1 || !['weapon', 'armor', 'helmet'].includes(itemToEquip?.type)) { 
                    this.showNotification('<i class="fas fa-exclamation-triangle"></i> Geçersiz eşya veya kuşanılabilir değil!', 'error'); return; 
                }
                if (!glad.isAlive) { // Ölü gladyatöre eşya kuşanılamaz
                     this.showNotification('<i class="fas fa-exclamation-triangle"></i> Ölü gladyatöre eşya kuşanamazsın!', 'error'); return;
                }

                const existingEquipped = glad.equippedItems[itemToEquip.type];
                if (existingEquipped) { 
                    glad.unequipItem(itemToEquip.type); 
                    this.state.inventory.push(existingEquipped); 
                    this.showNotification(<i class="fas fa-undo"></i> <strong>${existingEquipped.name}</strong> çıkarıldı., 'info'); 
                }
                glad.equipItem(itemToEquip); 
                this.state.inventory.splice(itemIdx, 1);
                // Canı max canına göre ayarla (stat değişimi olabilir)
                glad.currentHp = Math.min(glad.currentHp, glad.getEffectiveStat('stamina')); 
                this.showNotification(<i class="fas fa-check-circle"></i> <strong>${glad.name}</strong>, <strong>${itemToEquip.name}</strong>'i kuşandı!, 'success');
                this.updateUI(); 
                this.showGladiatorDetails(gladId, false); // Modalı açık tut ve yenile
            }
            unequipItem(gladId, itemType) {
                const glad = this.state.gladiators.find(g => g.id === gladId); 
                if (!glad || !glad.equippedItems[itemType]) {
                    this.showNotification('<i class="fas fa-info-circle"></i> Gladyatör veya kuşanılmış eşya bulunamadı!', 'error');
                    return;
                }
                const unequippedItem = glad.equippedItems[itemType]; 
                glad.equippedItems[itemType] = null; 
                this.state.inventory.push(unequippedItem); 
                glad.currentHp = Math.min(glad.currentHp, glad.getEffectiveStat('stamina'));
                this.showNotification(<i class="fas fa-box"></i> <strong>${glad.name}</strong>, <strong>${unequippedItem.name}</strong>'i çıkardı., 'info');
                this.updateUI(); 
                this.showGladiatorDetails(gladId, false); // Modalı açık tut ve yenile
            }
            usePotion(gladId, itemId) {
                const glad = this.state.gladiators.find(g => g.id === gladId); 
                const itemIdx = this.state.inventory.findIndex(i => i.id === itemId);
                const potion = this.state.inventory[itemIdx];
                
                if (!glad || itemIdx === -1 || potion?.type !== 'consumable' || !potion.healAmount) { 
                    this.showNotification('<i class="fas fa-exclamation-triangle"></i> Geçersiz iksir!', 'error'); return; 
                }
                if (!glad.isAlive) {
                    this.showNotification('<i class="fas fa-exclamation-triangle"></i> Ölü gladyatöre iksir kullanamazsın! Şifacıyı dene.', 'error'); return;
                }
                if (glad.currentHp >= glad.getEffectiveStat('stamina')) { 
                    this.showNotification(<i class="fas fa-info-circle"></i> <strong>${glad.name}</strong>'nin canı zaten dolu!, 'info'); return; 
                }
                glad.heal(potion.healAmount); 
                this.state.inventory.splice(itemIdx, 1);
                this.showNotification(<i class="fas fa-syringe"></i> <strong>${glad.name}</strong>, <strong>${potion.name}</strong> kullandı ve canı iyileşti!, 'success');
                this.updateUI(); 
                this.showGladiatorDetails(gladId, false); // Modalı açık tut ve yenile
            }
            showGladiatorDetails(gladId, shouldCloseModal = true) {
                this.selectedGladiatorIdForModal = gladId; 
                const glad = this.state.gladiators.find(g => g.id === gladId); 
                if (!glad) { console.warn("Gladiator not found for details display:", gladId); return; }

                // Satış fiyatını hesapla
                const baseRecruitCost = CONFIG.recruitmentOptions[glad.type.toLowerCase()]?.cost || 0;
                let sellPrice = Math.round(
                    (CONFIG.gladiatorSellValueMultiplier.base * baseRecruitCost) + 
                    (glad.level * CONFIG.gladiatorSellValueMultiplier.perLevel) + 
                    (glad.wins * CONFIG.gladiatorSellValueMultiplier.perWin) + 
                    (glad.traits.length * CONFIG.gladiatorSellValueMultiplier.perTrait)
                );
                if (!glad.isAlive) { sellPrice = Math.round(sellPrice * 0.25); } // Ölü ise %25 değerinde
                sellPrice = Math.max(0, sellPrice);

                const equippedHtml = <h4>Kuşanılan Eşyalar</h4><ul class="equipped-list"> + ['weapon', 'armor', 'helmet'].map(s => {
                    const item = glad.equippedItems[s]; 
                    return item ? `<li><strong>${item.name}</strong> ${item.level ? (Lvl ${item.level}) : ''} <span class="item-rarity rarity-${item.rarity}">${item.rarity}</span> <span class="item-stats-summary">${item.getBonusString()}</span><span><button class="btn btn-unequip" onclick="game.unequipItem('${glad.id}', '${s}')">Çıkar</button>${item.maxLevel > 0 && item.level < item.maxLevel ? <button class="btn btn-upgrade" onclick="game.upgradeItem('${glad.id}', '${item.id}')">Yükselt</button> : (item.maxLevel > 0 ? '<span style="font-size:0.8em; margin-left:10px;">(Maks Seviye)</span>' : '')}</span></li>` : <li>Boş - ${s.charAt(0).toUpperCase() + s.slice(1)}</li>;
                }).join('') + </ul>;

                const inventoryHtml = <h4>Envanterdeki Eşyalar</h4><ul class="inventory-list"> + (this.state.inventory.length ? this.state.inventory.map(item => `<li><strong>${item.name}</strong> ${item.level ? (Lvl ${item.level}) : ''} <span class="item-rarity rarity-${item.rarity}">${item.rarity}</span> <span class="item-stats-summary">${item.getBonusString()}</span><span>${['weapon', 'armor', 'helmet'].includes(item.type) ? <button class="btn btn-equip" onclick="game.equipItem('${glad.id}', '${item.id}')">Kuşan</button> : item.type === 'consumable' ? <button class="btn btn-use" onclick="game.usePotion('${glad.id}', '${item.id}')">Kullan</button> : ''}<button class="btn btn-sell" onclick="game.sellItem('${item.id}')">Sat (${item.sellValue} <i class="fas fa-coins"></i>)</button></span></li>`).join('') : '<p>Envanterin boş.</p>') + </ul>;
